"use strict";

var _regenerator = require("babel-runtime/regenerator");

var _regenerator2 = _interopRequireDefault(_regenerator);

var _promise = require("babel-runtime/core-js/promise");

var _promise2 = _interopRequireDefault(_promise);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var __awaiter = undefined && undefined.__awaiter || function (thisArg, _arguments, P, generator) {
    return new (P || (P = _promise2.default))(function (resolve, reject) {
        function fulfilled(value) {
            try {
                step(generator.next(value));
            } catch (e) {
                reject(e);
            }
        }
        function rejected(value) {
            try {
                step(generator.throw(value));
            } catch (e) {
                reject(e);
            }
        }
        function step(result) {
            result.done ? resolve(result.value) : new P(function (resolve) {
                resolve(result.value);
            }).then(fulfilled, rejected);
        }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
var fs = require("fs");
var string_decoder_1 = require("string_decoder");
function readTextFile(path) {
    return __awaiter(this, void 0, void 0, _regenerator2.default.mark(function _callee() {
        var stat, fd, result, buffer, readBomResult, encodingInfo, decoder, textOffset, textSize, readFileResult;
        return _regenerator2.default.wrap(function _callee$(_context) {
            while (1) {
                switch (_context.prev = _context.next) {
                    case 0:
                        _context.next = 2;
                        return fileStat(path);

                    case 2:
                        stat = _context.sent;
                        fd = null;
                        result = void 0;
                        _context.prev = 5;
                        _context.next = 8;
                        return openFile(path, "r");

                    case 8:
                        fd = _context.sent;
                        buffer = new Buffer(maxBomLength);
                        _context.next = 12;
                        return readFile(fd, buffer, 0, maxBomLength, 0);

                    case 12:
                        readBomResult = _context.sent;
                        encodingInfo = getEncodingInfo(readBomResult.buffer);
                        decoder = new string_decoder_1.StringDecoder(encodingInfo.encoding);
                        textOffset = encodingInfo.bomLength;
                        textSize = stat.size - encodingInfo.bomLength;

                        buffer = new Buffer(textSize);
                        _context.next = 20;
                        return readFile(fd, buffer, 0, textSize, encodingInfo.bomLength);

                    case 20:
                        readFileResult = _context.sent;

                        result = decoder.write(readFileResult.buffer);

                    case 22:
                        _context.prev = 22;

                        if (!(fd !== null && fd !== undefined)) {
                            _context.next = 26;
                            break;
                        }

                        _context.next = 26;
                        return closeFile(fd);

                    case 26:
                        return _context.finish(22);

                    case 27:
                        return _context.abrupt("return", result);

                    case 28:
                    case "end":
                        return _context.stop();
                }
            }
        }, _callee, this, [[5,, 22, 27]]);
    }));
}
exports.readTextFile = readTextFile;
function readTextFileSync(path) {
    var stat = fs.statSync(path);
    var fd = null;
    var result = void 0;
    try {
        fd = fs.openSync(path, "r");
        var buffer = new Buffer(maxBomLength);
        fs.readSync(fd, buffer, 0, maxBomLength, 0);
        var encodingInfo = getEncodingInfo(buffer);
        var decoder = new string_decoder_1.StringDecoder(encodingInfo.encoding);
        var textOffset = encodingInfo.bomLength;
        var textSize = stat.size - encodingInfo.bomLength;
        buffer = new Buffer(textSize);
        fs.readSync(fd, buffer, 0, textSize, encodingInfo.bomLength);
        result = decoder.write(buffer);
    } finally {
        if (fd !== null && fd !== undefined) {
            fs.closeSync(fd);
        }
    }
    return result;
}
exports.readTextFileSync = readTextFileSync;
function getEncodingInfo(buffer) {
    var encoding = defaultTextFileEncoding;
    var bomLength = 0;
    for (var bomMapItemName in bomMap) {
        var bomMapItem = bomMap[bomMapItemName];
        if (isBomMatch(bomMapItem, buffer)) {
            if (typeof bomMapItem.encoding !== "string") {
                throw new Error("Unsupported text file encoding");
            }
            bomLength = bomMapItem.bom.length;
            encoding = bomMapItem.encoding;
            break;
        }
    }
    return { encoding: encoding, bomLength: bomLength };
}
var utf8FileTextEncoding = "utf-8";
var defaultTextFileEncoding = utf8FileTextEncoding;
var bomMap = {
    bomUTF_8: { bom: [0xEF, 0xBB, 0xBF], encoding: utf8FileTextEncoding },
    bomUTF_16_BE: { bom: [0xFE, 0xFF], encoding: "" },
    bomUTF_16_LE: { bom: [0xFF, 0xFE], encoding: "" },
    bomUTF_32_BE: { bom: [0x00, 0x00, 0xFE, 0xFF], encoding: "" },
    bomUTF_32_LE: { bom: [0xFF, 0xFE, 0x00, 0x00], encoding: "" },
    bomUTF_7_a: { bom: [0x2B, 0x2F, 0x76, 0x38], encoding: "" },
    bomUTF_7_b: { bom: [0x2B, 0x2F, 0x76, 0x39], encoding: "" },
    bomUTF_7_c: { bom: [0x2B, 0x2F, 0x76, 0x2B], encoding: "" },
    bomUTF_7_d: { bom: [0x2B, 0x2F, 0x76, 0x2F], encoding: "" },
    bomUTF_7_e: { bom: [0x2B, 0x2F, 0x76, 0x38, 0x2D], encoding: "" },
    bomUTF_1: { bom: [0xF7, 0x64, 0x4C], encoding: "" },
    bomUTF_EBCDIC: { bom: [0xDD, 0x73, 0x66, 0x73], encoding: "" },
    bomSCSU: { bom: [0x0E, 0xFE, 0xFF], encoding: "" },
    bomBOCU_1: { bom: [0xFB, 0xEE, 0x28], encoding: "" },
    bomGB_18030: { bom: [0x84, 0x31, 0x95, 0x33], encoding: "" }
};
var maxBomLength = 0;
for (var bomMapItemName in bomMap) {
    var bomMapItem = bomMap[bomMapItemName];
    maxBomLength = Math.max(maxBomLength, bomMapItem.bom.length);
}
function isBomMatch(mapItem, bom) {
    if (bom.length < mapItem.bom.length) {
        return false;
    }
    for (var i = 0; i < mapItem.bom.length; i++) {
        if (bom[i] != mapItem.bom[i]) {
            return false;
        }
    }
    return true;
}
// TODO: share these, or try fs-promise (or similar)
function fileStat(path) {
    return new _promise2.default(function (resolve, reject) {
        fs.stat(path, function (err, stats) {
            if (null !== err && undefined !== err) {
                reject(err);
            } else {
                resolve(stats);
            }
        });
    });
}
function openFile(path, flags) {
    return new _promise2.default(function (resolve, reject) {
        fs.open(path, flags, function (err, fd) {
            if (null !== err && undefined !== err) {
                reject(err);
            } else {
                resolve(fd);
            }
        });
    });
}
function readFile(fd, buffer, offset, length, position) {
    return new _promise2.default(function (resolve, reject) {
        fs.read(fd, buffer, offset, length, position, function (err, bytesRead, buffer) {
            if (null !== err && undefined !== err) {
                reject(err);
            } else {
                resolve({ bytesRead: bytesRead, buffer: buffer });
            }
        });
    });
}
function closeFile(fd) {
    return new _promise2.default(function (resolve, reject) {
        fs.close(fd, function (err) {
            if (null !== err && undefined !== err) {
                reject(err);
            } else {
                resolve();
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZC10ZXh0LWZpbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcmVhZC10ZXh0LWZpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsSUFBWSxBQUFFLGFBQU0sQUFBSSxBQUFDO0FBR3pCLCtCQUE4QixBQUFnQixBQUFDO0FBRS9DLHNCQUFtQyxBQUFZOztBQUU5Qzs7Ozs7OytCQUFpQixBQUFRLFNBQUMsQUFBSSxBQUFDLEFBQUMsQUFFaEM7OztBQUZJLEFBQUksQUFBRztBQUVQLEFBQUUsNkJBQVcsQUFBSSxBQUFDLEFBQ3RCO0FBQUksQUFBYyxBQUFDLEFBRW5CLEFBQ0EsQUFBQzs7OytCQUNXLEFBQVEsU0FBQyxBQUFJLE1BQUUsQUFBRyxBQUFDLEFBQUMsQUFFL0I7OztBQUZBLEFBQUUsQUFBRztBQUVELEFBQU0saUNBQUcsSUFBSSxBQUFNLE9BQUMsQUFBWSxBQUFDLEFBQUMsQUFDdEM7OytCQUEwQixBQUFRLFNBQUMsQUFBRSxJQUFFLEFBQU0sUUFBRSxBQUFDLEdBQUUsQUFBWSxjQUFFLEFBQUMsQUFBQyxBQUFDLEFBRW5FOzs7QUFGSSxBQUFhLEFBQUc7QUFFaEIsQUFBWSx1Q0FBRyxBQUFlLGdCQUFDLEFBQWEsY0FBQyxBQUFNLEFBQUMsQUFBQyxBQUV6RDtBQUFJLEFBQU8sa0NBQUcsSUFBSSxpQkFBYSxjQUFDLEFBQVksYUFBQyxBQUFRLEFBQUMsQUFBQyxBQUV2RDtBQUFJLEFBQVUscUNBQUcsQUFBWSxhQUFDLEFBQVMsQUFBQyxBQUN4QztBQUFJLEFBQVEsbUNBQUcsQUFBSSxLQUFDLEFBQUksT0FBRyxBQUFZLGFBQUMsQUFBUyxBQUFDOztBQUVsRCxBQUFNLGlDQUFHLElBQUksQUFBTSxPQUFDLEFBQVEsQUFBQyxBQUFDLEFBQzlCOzsrQkFBMkIsQUFBUSxTQUFDLEFBQUUsSUFBRSxBQUFNLFFBQUUsQUFBQyxHQUFFLEFBQVEs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Q0wsS0FyQlEsQUFBSSxBQUFPO0FBcUJsQjtBQUVELG1CQUFtQixBQUFVO0FBRTVCLEFBQU0saUNBQ0wsVUFBVSxBQUFPLFNBQUUsQUFBTTtBQUV4QixBQUFFLFdBQUMsQUFBSyxNQUNQLEFBQUUsSUFDRixVQUFVLEFBQUc7QUFFWixBQUFFLEFBQUMsZ0JBQUUsQUFBSSxTQUFLLEFBQUcsQUFBQyxBQUFJLEdBQWxCLElBQW1CLEFBQVMsY0FBSyxBQUFHLEFBQUMsQUFBQyxLQUMxQyxBQUFDO0FBQ0EsQUFBTSx1QkFBQyxBQUFHLEFBQUMsQUFBQyxBQUNiO0FBQUMsQUFDRCxBQUFJLG1CQUNKLEFBQUM7QUFDQSxBQUFPLEFBQUUsQUFBQyxBQUNYO0FBQUMsQUFDRjtBQUFDLEFBQUMsQUFBQyxBQUNMO0FBQUMsQUFBQyxBQUFDLEFBQ0wsS0FqQlEsQUFBSSxBQUFPO0FBaUJsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuXG5pbXBvcnQgeyBTdHJpbmdEZWNvZGVyIH0gZnJvbSBcInN0cmluZ19kZWNvZGVyXCI7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWFkVGV4dEZpbGUocGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+XG57XG5cdGxldCBzdGF0ID0gYXdhaXQgZmlsZVN0YXQocGF0aCk7XG5cblx0bGV0IGZkOiBudW1iZXIgPSBudWxsO1xuXHRsZXQgcmVzdWx0OiBzdHJpbmc7XG5cblx0dHJ5XG5cdHtcblx0XHRmZCA9IGF3YWl0IG9wZW5GaWxlKHBhdGgsIFwiclwiKTtcblxuXHRcdGxldCBidWZmZXIgPSBuZXcgQnVmZmVyKG1heEJvbUxlbmd0aCk7XG5cdFx0bGV0IHJlYWRCb21SZXN1bHQgPSBhd2FpdCByZWFkRmlsZShmZCwgYnVmZmVyLCAwLCBtYXhCb21MZW5ndGgsIDApO1xuXG5cdFx0bGV0IGVuY29kaW5nSW5mbyA9IGdldEVuY29kaW5nSW5mbyhyZWFkQm9tUmVzdWx0LmJ1ZmZlcik7XG5cblx0XHRsZXQgZGVjb2RlciA9IG5ldyBTdHJpbmdEZWNvZGVyKGVuY29kaW5nSW5mby5lbmNvZGluZyk7XG5cblx0XHRsZXQgdGV4dE9mZnNldCA9IGVuY29kaW5nSW5mby5ib21MZW5ndGg7XG5cdFx0bGV0IHRleHRTaXplID0gc3RhdC5zaXplIC0gZW5jb2RpbmdJbmZvLmJvbUxlbmd0aDtcblxuXHRcdGJ1ZmZlciA9IG5ldyBCdWZmZXIodGV4dFNpemUpO1xuXHRcdGxldCByZWFkRmlsZVJlc3VsdCA9IGF3YWl0IHJlYWRGaWxlKGZkLCBidWZmZXIsIDAsIHRleHRTaXplLCBlbmNvZGluZ0luZm8uYm9tTGVuZ3RoKTtcblxuXHRcdHJlc3VsdCA9IGRlY29kZXIud3JpdGUocmVhZEZpbGVSZXN1bHQuYnVmZmVyKTtcblx0fVxuXHRmaW5hbGx5XG5cdHtcblx0XHRpZiAoKGZkICE9PSBudWxsKSAmJiAoZmQgIT09IHVuZGVmaW5lZCkpXG5cdFx0e1xuXHRcdFx0YXdhaXQgY2xvc2VGaWxlKGZkKTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVhZFRleHRGaWxlU3luYyhwYXRoOiBzdHJpbmcpOiBzdHJpbmdcbntcblx0bGV0IHN0YXQgPSBmcy5zdGF0U3luYyhwYXRoKTtcblxuXHRsZXQgZmQ6IG51bWJlciA9IG51bGw7XG5cdGxldCByZXN1bHQ6IHN0cmluZztcblxuXHR0cnlcblx0e1xuXHRcdGZkID0gZnMub3BlblN5bmMocGF0aCwgXCJyXCIpO1xuXG5cdFx0bGV0IGJ1ZmZlciA9IG5ldyBCdWZmZXIobWF4Qm9tTGVuZ3RoKTtcblx0XHRmcy5yZWFkU3luYyhmZCwgYnVmZmVyLCAwLCBtYXhCb21MZW5ndGgsIDApO1xuXG5cdFx0bGV0IGVuY29kaW5nSW5mbyA9IGdldEVuY29kaW5nSW5mbyhidWZmZXIpO1xuXG5cdFx0bGV0IGRlY29kZXIgPSBuZXcgU3RyaW5nRGVjb2RlcihlbmNvZGluZ0luZm8uZW5jb2RpbmcpO1xuXG5cdFx0bGV0IHRleHRPZmZzZXQgPSBlbmNvZGluZ0luZm8uYm9tTGVuZ3RoO1xuXHRcdGxldCB0ZXh0U2l6ZSA9IHN0YXQuc2l6ZSAtIGVuY29kaW5nSW5mby5ib21MZW5ndGg7XG5cblx0XHRidWZmZXIgPSBuZXcgQnVmZmVyKHRleHRTaXplKTtcblx0XHRmcy5yZWFkU3luYyhmZCwgYnVmZmVyLCAwLCB0ZXh0U2l6ZSwgZW5jb2RpbmdJbmZvLmJvbUxlbmd0aCk7XG5cblx0XHRyZXN1bHQgPSBkZWNvZGVyLndyaXRlKGJ1ZmZlcik7XG5cdH1cblx0ZmluYWxseVxuXHR7XG5cdFx0aWYgKChmZCAhPT0gbnVsbCkgJiYgKGZkICE9PSB1bmRlZmluZWQpKVxuXHRcdHtcblx0XHRcdGZzLmNsb3NlU3luYyhmZCk7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHJlc3VsdDtcbn1cblxuaW50ZXJmYWNlIEVuY29kaW5nSW5mb1xue1xuXHRlbmNvZGluZzogc3RyaW5nO1xuXHRib21MZW5ndGg6IG51bWJlcjtcbn1cblxuZnVuY3Rpb24gZ2V0RW5jb2RpbmdJbmZvKGJ1ZmZlcjogQnVmZmVyKTogRW5jb2RpbmdJbmZvXG57XG5cdGxldCBlbmNvZGluZyA9IGRlZmF1bHRUZXh0RmlsZUVuY29kaW5nO1xuXHRsZXQgYm9tTGVuZ3RoID0gMDtcblxuXHRmb3IgKGxldCBib21NYXBJdGVtTmFtZSBpbiBib21NYXApXG5cdHtcblx0XHRsZXQgYm9tTWFwSXRlbSA9IChib21NYXAgYXMgYW55KVtib21NYXBJdGVtTmFtZV0gYXMgQm9tTWFwSXRlbTtcblxuXHRcdGlmIChpc0JvbU1hdGNoKGJvbU1hcEl0ZW0sIGJ1ZmZlcikpXG5cdFx0e1xuXHRcdFx0aWYgKCh0eXBlb2YgKGJvbU1hcEl0ZW0uZW5jb2RpbmcpICE9PSBcInN0cmluZ1wiKSlcblx0XHRcdHtcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiVW5zdXBwb3J0ZWQgdGV4dCBmaWxlIGVuY29kaW5nXCIpO1xuXHRcdFx0fVxuXG5cdFx0XHRib21MZW5ndGggPSBib21NYXBJdGVtLmJvbS5sZW5ndGg7XG5cdFx0XHRlbmNvZGluZyA9IGJvbU1hcEl0ZW0uZW5jb2Rpbmc7XG5cblx0XHRcdGJyZWFrO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiB7IGVuY29kaW5nOiBlbmNvZGluZywgYm9tTGVuZ3RoOiBib21MZW5ndGggfTtcbn1cblxuaW50ZXJmYWNlIEJvbU1hcEl0ZW1cbntcblx0Ym9tOiBudW1iZXJbXTtcblx0ZW5jb2Rpbmc6IHN0cmluZztcbn1cblxuY29uc3QgdXRmOEZpbGVUZXh0RW5jb2RpbmcgPSBcInV0Zi04XCI7XG5jb25zdCBkZWZhdWx0VGV4dEZpbGVFbmNvZGluZyA9IHV0ZjhGaWxlVGV4dEVuY29kaW5nO1xuXG5sZXQgYm9tTWFwID1cblx0e1xuXHRcdGJvbVVURl84OiB7IGJvbTogWzB4RUYsIDB4QkIsIDB4QkZdLCBlbmNvZGluZzogdXRmOEZpbGVUZXh0RW5jb2RpbmcgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tVVRGXzE2X0JFOiB7IGJvbTogWzB4RkUsIDB4RkZdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cdFx0Ym9tVVRGXzE2X0xFOiB7IGJvbTogWzB4RkYsIDB4RkVdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cblx0XHRib21VVEZfMzJfQkU6IHsgYm9tOiBbMHgwMCwgMHgwMCwgMHhGRSwgMHhGRl0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblx0XHRib21VVEZfMzJfTEU6IHsgYm9tOiBbMHhGRiwgMHhGRSwgMHgwMCwgMHgwMF0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbVVURl83X2E6IHsgYm9tOiBbMHgyQiwgMHgyRiwgMHg3NiwgMHgzOF0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblx0XHRib21VVEZfN19iOiB7IGJvbTogWzB4MkIsIDB4MkYsIDB4NzYsIDB4MzldLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cdFx0Ym9tVVRGXzdfYzogeyBib206IFsweDJCLCAweDJGLCAweDc2LCAweDJCXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXHRcdGJvbVVURl83X2Q6IHsgYm9tOiBbMHgyQiwgMHgyRiwgMHg3NiwgMHgyRl0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblx0XHRib21VVEZfN19lOiB7IGJvbTogWzB4MkIsIDB4MkYsIDB4NzYsIDB4MzgsIDB4MkRdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cblx0XHRib21VVEZfMTogeyBib206IFsweEY3LCAweDY0LCAweDRDXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tVVRGX0VCQ0RJQzogeyBib206IFsweERELCAweDczLCAweDY2LCAweDczXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tU0NTVTogeyBib206IFsweDBFLCAweEZFLCAweEZGXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tQk9DVV8xOiB7IGJvbTogWzB4RkIsIDB4RUUsIDB4MjhdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cblx0XHRib21HQl8xODAzMDogeyBib206IFsweDg0LCAweDMxLCAweDk1LCAweDMzXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXHR9O1xuXG5sZXQgbWF4Qm9tTGVuZ3RoOiBudW1iZXIgPSAwO1xuXG5mb3IgKGxldCBib21NYXBJdGVtTmFtZSBpbiBib21NYXApXG57XG5cdGxldCBib21NYXBJdGVtID0gKGJvbU1hcCBhcyBhbnkpW2JvbU1hcEl0ZW1OYW1lXSBhcyBCb21NYXBJdGVtO1xuXHRtYXhCb21MZW5ndGggPSBNYXRoLm1heChtYXhCb21MZW5ndGgsIGJvbU1hcEl0ZW0uYm9tLmxlbmd0aCk7XG59XG5cbmZ1bmN0aW9uIGlzQm9tTWF0Y2gobWFwSXRlbTogQm9tTWFwSXRlbSwgYm9tOiBCdWZmZXIpXG57XG5cdGlmIChib20ubGVuZ3RoIDwgbWFwSXRlbS5ib20ubGVuZ3RoKVxuXHR7XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG5cblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBtYXBJdGVtLmJvbS5sZW5ndGg7IGkrKylcblx0e1xuXHRcdGlmIChib21baV0gIT0gbWFwSXRlbS5ib21baV0pXG5cdFx0e1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiB0cnVlO1xufVxuXG4vLyBUT0RPOiBzaGFyZSB0aGVzZSwgb3IgdHJ5IGZzLXByb21pc2UgKG9yIHNpbWlsYXIpXG5mdW5jdGlvbiBmaWxlU3RhdChwYXRoOiBzdHJpbmcgfCBCdWZmZXIpOiBQcm9taXNlPGZzLlN0YXRzPlxue1xuXHRyZXR1cm4gbmV3IFByb21pc2U8ZnMuU3RhdHM+KFxuXHRcdGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpXG5cdFx0e1xuXHRcdFx0ZnMuc3RhdChcblx0XHRcdFx0cGF0aCxcblx0XHRcdFx0ZnVuY3Rpb24gKGVyciwgc3RhdHMpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRpZiAoKG51bGwgIT09IGVycikgJiYgKHVuZGVmaW5lZCAhPT0gZXJyKSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlc29sdmUoc3RhdHMpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0fSk7XG59XG5cbmZ1bmN0aW9uIG9wZW5GaWxlKHBhdGg6IHN0cmluZyB8IEJ1ZmZlciwgZmxhZ3M6IHN0cmluZyB8IG51bWJlcik6IFByb21pc2U8bnVtYmVyPlxue1xuXHRyZXR1cm4gbmV3IFByb21pc2U8bnVtYmVyPihcblx0XHRmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KVxuXHRcdHtcblx0XHRcdGZzLm9wZW4oXG5cdFx0XHRcdHBhdGgsXG5cdFx0XHRcdGZsYWdzLFxuXHRcdFx0XHRmdW5jdGlvbiAoZXJyLCBmZClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGlmICgobnVsbCAhPT0gZXJyKSAmJiAodW5kZWZpbmVkICE9PSBlcnIpKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlamVjdChlcnIpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVzb2x2ZShmZCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHR9KTtcbn1cblxuaW50ZXJmYWNlIFJlYWRGaWxlUmVzdWx0XG57XG5cdGJ5dGVzUmVhZDogbnVtYmVyO1xuXHRidWZmZXI6IEJ1ZmZlcjtcbn1cblxuZnVuY3Rpb24gcmVhZEZpbGUoZmQ6IG51bWJlciwgYnVmZmVyOiBCdWZmZXIsIG9mZnNldDogbnVtYmVyLCBsZW5ndGg6IG51bWJlciwgcG9zaXRpb246IG51bWJlcik6IFByb21pc2U8UmVhZEZpbGVSZXN1bHQ+XG57XG5cdHJldHVybiBuZXcgUHJvbWlzZTxSZWFkRmlsZVJlc3VsdD4oXG5cdFx0ZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdClcblx0XHR7XG5cdFx0XHRmcy5yZWFkKFxuXHRcdFx0XHRmZCxcblx0XHRcdFx0YnVmZmVyLFxuXHRcdFx0XHRvZmZzZXQsXG5cdFx0XHRcdGxlbmd0aCxcblx0XHRcdFx0cG9zaXRpb24sXG5cdFx0XHRcdGZ1bmN0aW9uIChlcnIsIGJ5dGVzUmVhZCwgYnVmZmVyKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKChudWxsICE9PSBlcnIpICYmICh1bmRlZmluZWQgIT09IGVycikpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVqZWN0KGVycik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZXNvbHZlKHsgYnl0ZXNSZWFkOiBieXRlc1JlYWQsIGJ1ZmZlcjogYnVmZmVyIH0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0fSk7XG59XG5cbmZ1bmN0aW9uIGNsb3NlRmlsZShmZDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPlxue1xuXHRyZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oXG5cdFx0ZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdClcblx0XHR7XG5cdFx0XHRmcy5jbG9zZShcblx0XHRcdFx0ZmQsXG5cdFx0XHRcdGZ1bmN0aW9uIChlcnIpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRpZiAoKG51bGwgIT09IGVycikgJiYgKHVuZGVmaW5lZCAhPT0gZXJyKSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlc29sdmUoKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdH0pO1xufSJdfQ==