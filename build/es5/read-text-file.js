"use strict";

var __awaiter = undefined && undefined.__awaiter || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) {
            try {
                step(generator.next(value));
            } catch (e) {
                reject(e);
            }
        }
        function rejected(value) {
            try {
                step(generator.throw(value));
            } catch (e) {
                reject(e);
            }
        }
        function step(result) {
            result.done ? resolve(result.value) : new P(function (resolve) {
                resolve(result.value);
            }).then(fulfilled, rejected);
        }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
require("babel-polyfill");
var fs = require("fs");
var string_decoder_1 = require("string_decoder");
function readTextFile(path) {
    return __awaiter(this, void 0, void 0, regeneratorRuntime.mark(function _callee() {
        var stat, fd, result, buffer, readBomResult, encodingInfo, decoder, textOffset, textSize, readFileResult;
        return regeneratorRuntime.wrap(function _callee$(_context) {
            while (1) {
                switch (_context.prev = _context.next) {
                    case 0:
                        _context.next = 2;
                        return fileStat(path);

                    case 2:
                        stat = _context.sent;
                        fd = null;
                        result = void 0;
                        _context.prev = 5;
                        _context.next = 8;
                        return openFile(path, "r");

                    case 8:
                        fd = _context.sent;
                        buffer = new Buffer(maxBomLength);
                        _context.next = 12;
                        return readFile(fd, buffer, 0, maxBomLength, 0);

                    case 12:
                        readBomResult = _context.sent;
                        encodingInfo = getEncodingInfo(readBomResult.buffer);
                        decoder = new string_decoder_1.StringDecoder(encodingInfo.encoding);
                        textOffset = encodingInfo.bomLength;
                        textSize = stat.size - encodingInfo.bomLength;

                        buffer = new Buffer(textSize);
                        _context.next = 20;
                        return readFile(fd, buffer, 0, textSize, encodingInfo.bomLength);

                    case 20:
                        readFileResult = _context.sent;

                        result = decoder.write(readFileResult.buffer);

                    case 22:
                        _context.prev = 22;

                        if (!(fd !== null && fd !== undefined)) {
                            _context.next = 26;
                            break;
                        }

                        _context.next = 26;
                        return closeFile(fd);

                    case 26:
                        return _context.finish(22);

                    case 27:
                        return _context.abrupt("return", result);

                    case 28:
                    case "end":
                        return _context.stop();
                }
            }
        }, _callee, this, [[5,, 22, 27]]);
    }));
}
exports.readTextFile = readTextFile;
function readTextFileSync(path) {
    var stat = fs.statSync(path);
    var fd = null;
    var result = void 0;
    try {
        fd = fs.openSync(path, "r");
        var buffer = new Buffer(maxBomLength);
        fs.readSync(fd, buffer, 0, maxBomLength, 0);
        var encodingInfo = getEncodingInfo(buffer);
        var decoder = new string_decoder_1.StringDecoder(encodingInfo.encoding);
        var textOffset = encodingInfo.bomLength;
        var textSize = stat.size - encodingInfo.bomLength;
        buffer = new Buffer(textSize);
        fs.readSync(fd, buffer, 0, textSize, encodingInfo.bomLength);
        result = decoder.write(buffer);
    } finally {
        if (fd !== null && fd !== undefined) {
            fs.closeSync(fd);
        }
    }
    return result;
}
exports.readTextFileSync = readTextFileSync;
function getEncodingInfo(buffer) {
    var encoding = defaultTextFileEncoding;
    var bomLength = 0;
    for (var bomMapItemName in bomMap) {
        var bomMapItem = bomMap[bomMapItemName];
        if (isBomMatch(bomMapItem, buffer)) {
            if (typeof bomMapItem.encoding !== "string") {
                throw new Error("Unsupported text file encoding");
            }
            bomLength = bomMapItem.bom.length;
            encoding = bomMapItem.encoding;
            break;
        }
    }
    return { encoding: encoding, bomLength: bomLength };
}
var utf8FileTextEncoding = "utf-8";
var defaultTextFileEncoding = utf8FileTextEncoding;
// TODO: support others? at least utf-16??
var bomMap = {
    bomUTF_8: { bom: [0xEF, 0xBB, 0xBF], encoding: utf8FileTextEncoding },
    bomUTF_16_BE: { bom: [0xFE, 0xFF], encoding: "" },
    bomUTF_16_LE: { bom: [0xFF, 0xFE], encoding: "" },
    bomUTF_32_BE: { bom: [0x00, 0x00, 0xFE, 0xFF], encoding: "" },
    bomUTF_32_LE: { bom: [0xFF, 0xFE, 0x00, 0x00], encoding: "" },
    bomUTF_7_a: { bom: [0x2B, 0x2F, 0x76, 0x38], encoding: "" },
    bomUTF_7_b: { bom: [0x2B, 0x2F, 0x76, 0x39], encoding: "" },
    bomUTF_7_c: { bom: [0x2B, 0x2F, 0x76, 0x2B], encoding: "" },
    bomUTF_7_d: { bom: [0x2B, 0x2F, 0x76, 0x2F], encoding: "" },
    bomUTF_7_e: { bom: [0x2B, 0x2F, 0x76, 0x38, 0x2D], encoding: "" },
    bomUTF_1: { bom: [0xF7, 0x64, 0x4C], encoding: "" },
    bomUTF_EBCDIC: { bom: [0xDD, 0x73, 0x66, 0x73], encoding: "" },
    bomSCSU: { bom: [0x0E, 0xFE, 0xFF], encoding: "" },
    bomBOCU_1: { bom: [0xFB, 0xEE, 0x28], encoding: "" },
    bomGB_18030: { bom: [0x84, 0x31, 0x95, 0x33], encoding: "" }
};
var maxBomLength = 0;
for (var bomMapItemName in bomMap) {
    var bomMapItem = bomMap[bomMapItemName];
    maxBomLength = Math.max(maxBomLength, bomMapItem.bom.length);
}
function isBomMatch(mapItem, bom) {
    if (bom.length < mapItem.bom.length) {
        return false;
    }
    for (var i = 0; i < mapItem.bom.length; i++) {
        if (bom[i] != mapItem.bom[i]) {
            return false;
        }
    }
    return true;
}
// TODO: share these, or try fs-promise (or similar)
function fileStat(path) {
    return new Promise(function (resolve, reject) {
        fs.stat(path, function (err, stats) {
            if (null !== err && undefined !== err) {
                reject(err);
            } else {
                resolve(stats);
            }
        });
    });
}
function openFile(path, flags) {
    return new Promise(function (resolve, reject) {
        fs.open(path, flags, function (err, fd) {
            if (null !== err && undefined !== err) {
                reject(err);
            } else {
                resolve(fd);
            }
        });
    });
}
function readFile(fd, buffer, offset, length, position) {
    return new Promise(function (resolve, reject) {
        fs.read(fd, buffer, offset, length, position, function (err, bytesRead, buffer) {
            if (null !== err && undefined !== err) {
                reject(err);
            } else {
                resolve({ bytesRead: bytesRead, buffer: buffer });
            }
        });
    });
}
function closeFile(fd) {
    return new Promise(function (resolve, reject) {
        fs.close(fd, function (err) {
            if (null !== err && undefined !== err) {
                reject(err);
            } else {
                resolve();
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZC10ZXh0LWZpbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcmVhZC10ZXh0LWZpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQSxBQUFPLFFBQUMsQUFBZ0IsQUFBQyxBQUFDO0FBRTFCLElBQVksQUFBRSxhQUFNLEFBQUksQUFBQztBQUd6QiwrQkFBOEIsQUFBZ0IsQUFBQztBQUUvQyxzQkFBbUMsQUFBWTs7QUFFOUM7Ozs7OzsrQkFBaUIsQUFBUSxTQUFDLEFBQUksQUFBQyxBQUFDLEFBRWhDOzs7QUFGSSxBQUFJLEFBQUc7QUFFUCxBQUFFLDZCQUFXLEFBQUksQUFBQyxBQUN0QjtBQUFJLEFBQWMsQUFBQyxBQUVuQixBQUNBLEFBQUM7OzsrQkFDVyxBQUFRLFNBQUMsQUFBSSxNQUFFLEFBQUcsQUFBQyxBQUFDLEFBRS9COzs7QUFGQSxBQUFFLEFBQUc7QUFFRCxBQUFNLGlDQUFHLElBQUksQUFBTSxPQUFDLEFBQVksQUFBQyxBQUFDLEFBQ3RDOzsrQkFBMEIsQUFBUSxTQUFDLEFBQUUsSUFBRSxBQUFNLFFBQUUsQUFBQyxHQUFFLEFBQVksY0FBRSxBQUFDLEFBQUMsQUFBQyxBQUVuRTs7O0FBRkksQUFBYSxBQUFHO0FBRWhCLEFBQVksdUNBQUcsQUFBZSxnQkFBQyxBQUFhLGNBQUMsQUFBTSxBQUFDLEFBQUMsQUFFekQ7QUFBSSxBQUFPLGtDQUFHLElBQUksaUJBQWEsY0FBQyxBQUFZLGFBQUMsQUFBUSxBQUFDLEFBQUMsQUFFdkQ7QUFBSSxBQUFVLHFDQUFHLEFBQVksYUFBQyxBQUFTLEFBQUMsQUFDeEM7QUFBSSxBQUFRLG1DQUFHLEFBQUksS0FBQyxBQUFJLE9BQUcsQUFBWSxhQUFDLEFBQVMsQUFBQzs7QUFFbEQsQUFBTSxpQ0FBRyxJQUFJLEFBQU0sT0FBQyxBQUFRLEFBQUMsQUFBQyxBQUM5Qjs7K0JBQTJCLEFBQVEsU0FBQyxBQUFFLElBQUUsQUFB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QUFDRjtBQUFDLEFBQUMsQUFBQyxBQUNMO0FBQUMsQUFBQyxBQUFDLEFBQ0wsS0FyQlE7QUFxQlA7QUFFRCxtQkFBbUIsQUFBVTtBQUU1QixBQUFNLGVBQUssQUFBTyxRQUNqQixVQUFVLEFBQU8sU0FBRSxBQUFNO0FBRXhCLEFBQUUsV0FBQyxBQUFLLE1BQ1AsQUFBRSxJQUNGLFVBQVUsQUFBRztBQUVaLEFBQUUsQUFBQyxnQkFBRSxBQUFJLFNBQUssQUFBRyxBQUFDLEFBQUksR0FBbEIsSUFBbUIsQUFBUyxjQUFLLEFBQUcsQUFBQyxBQUFDLEtBQzFDLEFBQUM7QUFDQSxBQUFNLHVCQUFDLEFBQUcsQUFBQyxBQUFDLEFBQ2I7QUFBQyxBQUNELEFBQUksbUJBQ0osQUFBQztBQUNBLEFBQU8sQUFBRSxBQUFDLEFBQ1g7QUFBQyxBQUNGO0FBQUMsQUFBQyxBQUFDLEFBQ0w7QUFBQyxBQUFDLEFBQUMsQUFDTCxLQWpCUTtBQWlCUCIsInNvdXJjZXNDb250ZW50IjpbImRlY2xhcmUgbGV0IHJlcXVpcmU6IGFueTtcbnJlcXVpcmUoXCJiYWJlbC1wb2x5ZmlsbFwiKTtcblxuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5cbmltcG9ydCB7IFN0cmluZ0RlY29kZXIgfSBmcm9tIFwic3RyaW5nX2RlY29kZXJcIjtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlYWRUZXh0RmlsZShwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz5cbntcblx0bGV0IHN0YXQgPSBhd2FpdCBmaWxlU3RhdChwYXRoKTtcblxuXHRsZXQgZmQ6IG51bWJlciA9IG51bGw7XG5cdGxldCByZXN1bHQ6IHN0cmluZztcblxuXHR0cnlcblx0e1xuXHRcdGZkID0gYXdhaXQgb3BlbkZpbGUocGF0aCwgXCJyXCIpO1xuXG5cdFx0bGV0IGJ1ZmZlciA9IG5ldyBCdWZmZXIobWF4Qm9tTGVuZ3RoKTtcblx0XHRsZXQgcmVhZEJvbVJlc3VsdCA9IGF3YWl0IHJlYWRGaWxlKGZkLCBidWZmZXIsIDAsIG1heEJvbUxlbmd0aCwgMCk7XG5cblx0XHRsZXQgZW5jb2RpbmdJbmZvID0gZ2V0RW5jb2RpbmdJbmZvKHJlYWRCb21SZXN1bHQuYnVmZmVyKTtcblxuXHRcdGxldCBkZWNvZGVyID0gbmV3IFN0cmluZ0RlY29kZXIoZW5jb2RpbmdJbmZvLmVuY29kaW5nKTtcblxuXHRcdGxldCB0ZXh0T2Zmc2V0ID0gZW5jb2RpbmdJbmZvLmJvbUxlbmd0aDtcblx0XHRsZXQgdGV4dFNpemUgPSBzdGF0LnNpemUgLSBlbmNvZGluZ0luZm8uYm9tTGVuZ3RoO1xuXG5cdFx0YnVmZmVyID0gbmV3IEJ1ZmZlcih0ZXh0U2l6ZSk7XG5cdFx0bGV0IHJlYWRGaWxlUmVzdWx0ID0gYXdhaXQgcmVhZEZpbGUoZmQsIGJ1ZmZlciwgMCwgdGV4dFNpemUsIGVuY29kaW5nSW5mby5ib21MZW5ndGgpO1xuXG5cdFx0cmVzdWx0ID0gZGVjb2Rlci53cml0ZShyZWFkRmlsZVJlc3VsdC5idWZmZXIpO1xuXHR9XG5cdGZpbmFsbHlcblx0e1xuXHRcdGlmICgoZmQgIT09IG51bGwpICYmIChmZCAhPT0gdW5kZWZpbmVkKSlcblx0XHR7XG5cdFx0XHRhd2FpdCBjbG9zZUZpbGUoZmQpO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWFkVGV4dEZpbGVTeW5jKHBhdGg6IHN0cmluZyk6IHN0cmluZ1xue1xuXHRsZXQgc3RhdCA9IGZzLnN0YXRTeW5jKHBhdGgpO1xuXG5cdGxldCBmZDogbnVtYmVyID0gbnVsbDtcblx0bGV0IHJlc3VsdDogc3RyaW5nO1xuXG5cdHRyeVxuXHR7XG5cdFx0ZmQgPSBmcy5vcGVuU3luYyhwYXRoLCBcInJcIik7XG5cblx0XHRsZXQgYnVmZmVyID0gbmV3IEJ1ZmZlcihtYXhCb21MZW5ndGgpO1xuXHRcdGZzLnJlYWRTeW5jKGZkLCBidWZmZXIsIDAsIG1heEJvbUxlbmd0aCwgMCk7XG5cblx0XHRsZXQgZW5jb2RpbmdJbmZvID0gZ2V0RW5jb2RpbmdJbmZvKGJ1ZmZlcik7XG5cblx0XHRsZXQgZGVjb2RlciA9IG5ldyBTdHJpbmdEZWNvZGVyKGVuY29kaW5nSW5mby5lbmNvZGluZyk7XG5cblx0XHRsZXQgdGV4dE9mZnNldCA9IGVuY29kaW5nSW5mby5ib21MZW5ndGg7XG5cdFx0bGV0IHRleHRTaXplID0gc3RhdC5zaXplIC0gZW5jb2RpbmdJbmZvLmJvbUxlbmd0aDtcblxuXHRcdGJ1ZmZlciA9IG5ldyBCdWZmZXIodGV4dFNpemUpO1xuXHRcdGZzLnJlYWRTeW5jKGZkLCBidWZmZXIsIDAsIHRleHRTaXplLCBlbmNvZGluZ0luZm8uYm9tTGVuZ3RoKTtcblxuXHRcdHJlc3VsdCA9IGRlY29kZXIud3JpdGUoYnVmZmVyKTtcblx0fVxuXHRmaW5hbGx5XG5cdHtcblx0XHRpZiAoKGZkICE9PSBudWxsKSAmJiAoZmQgIT09IHVuZGVmaW5lZCkpXG5cdFx0e1xuXHRcdFx0ZnMuY2xvc2VTeW5jKGZkKTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gcmVzdWx0O1xufVxuXG5pbnRlcmZhY2UgRW5jb2RpbmdJbmZvXG57XG5cdGVuY29kaW5nOiBzdHJpbmc7XG5cdGJvbUxlbmd0aDogbnVtYmVyO1xufVxuXG5mdW5jdGlvbiBnZXRFbmNvZGluZ0luZm8oYnVmZmVyOiBCdWZmZXIpOiBFbmNvZGluZ0luZm9cbntcblx0bGV0IGVuY29kaW5nID0gZGVmYXVsdFRleHRGaWxlRW5jb2Rpbmc7XG5cdGxldCBib21MZW5ndGggPSAwO1xuXG5cdGZvciAobGV0IGJvbU1hcEl0ZW1OYW1lIGluIGJvbU1hcClcblx0e1xuXHRcdGxldCBib21NYXBJdGVtID0gKGJvbU1hcCBhcyBhbnkpW2JvbU1hcEl0ZW1OYW1lXSBhcyBCb21NYXBJdGVtO1xuXG5cdFx0aWYgKGlzQm9tTWF0Y2goYm9tTWFwSXRlbSwgYnVmZmVyKSlcblx0XHR7XG5cdFx0XHRpZiAoKHR5cGVvZiAoYm9tTWFwSXRlbS5lbmNvZGluZykgIT09IFwic3RyaW5nXCIpKVxuXHRcdFx0e1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZCB0ZXh0IGZpbGUgZW5jb2RpbmdcIik7XG5cdFx0XHR9XG5cblx0XHRcdGJvbUxlbmd0aCA9IGJvbU1hcEl0ZW0uYm9tLmxlbmd0aDtcblx0XHRcdGVuY29kaW5nID0gYm9tTWFwSXRlbS5lbmNvZGluZztcblxuXHRcdFx0YnJlYWs7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHsgZW5jb2Rpbmc6IGVuY29kaW5nLCBib21MZW5ndGg6IGJvbUxlbmd0aCB9O1xufVxuXG5pbnRlcmZhY2UgQm9tTWFwSXRlbVxue1xuXHRib206IG51bWJlcltdO1xuXHRlbmNvZGluZzogc3RyaW5nO1xufVxuXG5jb25zdCB1dGY4RmlsZVRleHRFbmNvZGluZyA9IFwidXRmLThcIjtcbmNvbnN0IGRlZmF1bHRUZXh0RmlsZUVuY29kaW5nID0gdXRmOEZpbGVUZXh0RW5jb2Rpbmc7XG5cbi8vIFRPRE86IHN1cHBvcnQgb3RoZXJzPyBhdCBsZWFzdCB1dGYtMTY/P1xubGV0IGJvbU1hcCA9XG5cdHtcblx0XHRib21VVEZfODogeyBib206IFsweEVGLCAweEJCLCAweEJGXSwgZW5jb2Rpbmc6IHV0ZjhGaWxlVGV4dEVuY29kaW5nIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbVVURl8xNl9CRTogeyBib206IFsweEZFLCAweEZGXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXHRcdGJvbVVURl8xNl9MRTogeyBib206IFsweEZGLCAweEZFXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tVVRGXzMyX0JFOiB7IGJvbTogWzB4MDAsIDB4MDAsIDB4RkUsIDB4RkZdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cdFx0Ym9tVVRGXzMyX0xFOiB7IGJvbTogWzB4RkYsIDB4RkUsIDB4MDAsIDB4MDBdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cblx0XHRib21VVEZfN19hOiB7IGJvbTogWzB4MkIsIDB4MkYsIDB4NzYsIDB4MzhdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cdFx0Ym9tVVRGXzdfYjogeyBib206IFsweDJCLCAweDJGLCAweDc2LCAweDM5XSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXHRcdGJvbVVURl83X2M6IHsgYm9tOiBbMHgyQiwgMHgyRiwgMHg3NiwgMHgyQl0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblx0XHRib21VVEZfN19kOiB7IGJvbTogWzB4MkIsIDB4MkYsIDB4NzYsIDB4MkZdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cdFx0Ym9tVVRGXzdfZTogeyBib206IFsweDJCLCAweDJGLCAweDc2LCAweDM4LCAweDJEXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tVVRGXzE6IHsgYm9tOiBbMHhGNywgMHg2NCwgMHg0Q10sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbVVURl9FQkNESUM6IHsgYm9tOiBbMHhERCwgMHg3MywgMHg2NiwgMHg3M10sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbVNDU1U6IHsgYm9tOiBbMHgwRSwgMHhGRSwgMHhGRl0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbUJPQ1VfMTogeyBib206IFsweEZCLCAweEVFLCAweDI4XSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tR0JfMTgwMzA6IHsgYm9tOiBbMHg4NCwgMHgzMSwgMHg5NSwgMHgzM10sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblx0fTtcblxubGV0IG1heEJvbUxlbmd0aDogbnVtYmVyID0gMDtcbmZvciAobGV0IGJvbU1hcEl0ZW1OYW1lIGluIGJvbU1hcClcbntcblx0bGV0IGJvbU1hcEl0ZW0gPSAoYm9tTWFwIGFzIGFueSlbYm9tTWFwSXRlbU5hbWVdIGFzIEJvbU1hcEl0ZW07XG5cblx0bWF4Qm9tTGVuZ3RoID0gTWF0aC5tYXgobWF4Qm9tTGVuZ3RoLCBib21NYXBJdGVtLmJvbS5sZW5ndGgpO1xufVxuXG5mdW5jdGlvbiBpc0JvbU1hdGNoKG1hcEl0ZW06IEJvbU1hcEl0ZW0sIGJvbTogQnVmZmVyKVxue1xuXHRpZiAoYm9tLmxlbmd0aCA8IG1hcEl0ZW0uYm9tLmxlbmd0aClcblx0e1xuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgbWFwSXRlbS5ib20ubGVuZ3RoOyBpKyspXG5cdHtcblx0XHRpZiAoYm9tW2ldICE9IG1hcEl0ZW0uYm9tW2ldKVxuXHRcdHtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gdHJ1ZTtcbn1cblxuLy8gVE9ETzogc2hhcmUgdGhlc2UsIG9yIHRyeSBmcy1wcm9taXNlIChvciBzaW1pbGFyKVxuZnVuY3Rpb24gZmlsZVN0YXQocGF0aDogc3RyaW5nIHwgQnVmZmVyKTogUHJvbWlzZTxmcy5TdGF0cz5cbntcblx0cmV0dXJuIG5ldyBQcm9taXNlPGZzLlN0YXRzPihcblx0XHRmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KVxuXHRcdHtcblx0XHRcdGZzLnN0YXQoXG5cdFx0XHRcdHBhdGgsXG5cdFx0XHRcdGZ1bmN0aW9uIChlcnIsIHN0YXRzKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKChudWxsICE9PSBlcnIpICYmICh1bmRlZmluZWQgIT09IGVycikpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVqZWN0KGVycik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZXNvbHZlKHN0YXRzKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdH0pO1xufVxuXG5mdW5jdGlvbiBvcGVuRmlsZShwYXRoOiBzdHJpbmcgfCBCdWZmZXIsIGZsYWdzOiBzdHJpbmcgfCBudW1iZXIpOiBQcm9taXNlPG51bWJlcj5cbntcblx0cmV0dXJuIG5ldyBQcm9taXNlPG51bWJlcj4oXG5cdFx0ZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdClcblx0XHR7XG5cdFx0XHRmcy5vcGVuKFxuXHRcdFx0XHRwYXRoLFxuXHRcdFx0XHRmbGFncyxcblx0XHRcdFx0ZnVuY3Rpb24gKGVyciwgZmQpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRpZiAoKG51bGwgIT09IGVycikgJiYgKHVuZGVmaW5lZCAhPT0gZXJyKSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlc29sdmUoZmQpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0fSk7XG59XG5cbmludGVyZmFjZSBSZWFkRmlsZVJlc3VsdFxue1xuXHRieXRlc1JlYWQ6IG51bWJlcjtcblx0YnVmZmVyOiBCdWZmZXI7XG59XG5cbmZ1bmN0aW9uIHJlYWRGaWxlKGZkOiBudW1iZXIsIGJ1ZmZlcjogQnVmZmVyLCBvZmZzZXQ6IG51bWJlciwgbGVuZ3RoOiBudW1iZXIsIHBvc2l0aW9uOiBudW1iZXIpOiBQcm9taXNlPFJlYWRGaWxlUmVzdWx0Plxue1xuXHRyZXR1cm4gbmV3IFByb21pc2U8UmVhZEZpbGVSZXN1bHQ+KFxuXHRcdGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpXG5cdFx0e1xuXHRcdFx0ZnMucmVhZChcblx0XHRcdFx0ZmQsXG5cdFx0XHRcdGJ1ZmZlcixcblx0XHRcdFx0b2Zmc2V0LFxuXHRcdFx0XHRsZW5ndGgsXG5cdFx0XHRcdHBvc2l0aW9uLFxuXHRcdFx0XHRmdW5jdGlvbiAoZXJyLCBieXRlc1JlYWQsIGJ1ZmZlcilcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGlmICgobnVsbCAhPT0gZXJyKSAmJiAodW5kZWZpbmVkICE9PSBlcnIpKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlamVjdChlcnIpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVzb2x2ZSh7IGJ5dGVzUmVhZDogYnl0ZXNSZWFkLCBidWZmZXI6IGJ1ZmZlciB9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdH0pO1xufVxuXG5mdW5jdGlvbiBjbG9zZUZpbGUoZmQ6IG51bWJlcik6IFByb21pc2U8dm9pZD5cbntcblx0cmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KFxuXHRcdGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpXG5cdFx0e1xuXHRcdFx0ZnMuY2xvc2UoXG5cdFx0XHRcdGZkLFxuXHRcdFx0XHRmdW5jdGlvbiAoZXJyKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKChudWxsICE9PSBlcnIpICYmICh1bmRlZmluZWQgIT09IGVycikpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVqZWN0KGVycik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZXNvbHZlKCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHR9KTtcbn0iXX0=