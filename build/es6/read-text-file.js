"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
const fs = require("fs");
const string_decoder_1 = require("string_decoder");
function read(path) {
    return __awaiter(this, void 0, void 0, function* () {
        let stat = yield fileStat(path);
        let fd = null;
        let result;
        try {
            fd = yield openFile(path, "r");
            let buffer = new Buffer(maxBomLength);
            let readBomResult = yield readFile(fd, buffer, 0, maxBomLength, 0);
            let encodingInfo = getEncodingInfo(readBomResult.buffer);
            let decoder = new string_decoder_1.StringDecoder(encodingInfo.encoding);
            let textOffset = encodingInfo.bomLength;
            let textSize = stat.size - encodingInfo.bomLength;
            buffer = new Buffer(textSize);
            let readFileResult = yield readFile(fd, buffer, 0, textSize, encodingInfo.bomLength);
            result = decoder.write(readFileResult.buffer);
        }
        finally {
            if ((fd !== null) && (fd !== undefined)) {
                yield closeFile(fd);
            }
        }
        return result;
    });
}
exports.read = read;
function readSync(path) {
    let stat = fs.statSync(path);
    let fd = null;
    let result;
    try {
        fd = fs.openSync(path, "r");
        let buffer = new Buffer(maxBomLength);
        fs.readSync(fd, buffer, 0, maxBomLength, 0);
        let encodingInfo = getEncodingInfo(buffer);
        let decoder = new string_decoder_1.StringDecoder(encodingInfo.encoding);
        let textOffset = encodingInfo.bomLength;
        let textSize = stat.size - encodingInfo.bomLength;
        buffer = new Buffer(textSize);
        fs.readSync(fd, buffer, 0, textSize, encodingInfo.bomLength);
        result = decoder.write(buffer);
    }
    finally {
        if ((fd !== null) && (fd !== undefined)) {
            fs.closeSync(fd);
        }
    }
    return result;
}
exports.readSync = readSync;
function getEncodingInfo(buffer) {
    let encoding = defaultTextFileEncoding;
    let bomLength = 0;
    for (let bomMapItemName in bomMap) {
        let bomMapItem = bomMap[bomMapItemName];
        if (isBomMatch(bomMapItem, buffer)) {
            if ((typeof (bomMapItem.encoding) !== "string")) {
                throw new Error("Unsupported text file encoding");
            }
            bomLength = bomMapItem.bom.length;
            encoding = bomMapItem.encoding;
            break;
        }
    }
    return { encoding: encoding, bomLength: bomLength };
}
const utf8FileTextEncoding = "utf-8";
const defaultTextFileEncoding = utf8FileTextEncoding;
let bomMap = {
    bomUTF_8: { bom: [0xEF, 0xBB, 0xBF], encoding: utf8FileTextEncoding },
    bomUTF_16_BE: { bom: [0xFE, 0xFF], encoding: "" },
    bomUTF_16_LE: { bom: [0xFF, 0xFE], encoding: "" },
    bomUTF_32_BE: { bom: [0x00, 0x00, 0xFE, 0xFF], encoding: "" },
    bomUTF_32_LE: { bom: [0xFF, 0xFE, 0x00, 0x00], encoding: "" },
    bomUTF_7_a: { bom: [0x2B, 0x2F, 0x76, 0x38], encoding: "" },
    bomUTF_7_b: { bom: [0x2B, 0x2F, 0x76, 0x39], encoding: "" },
    bomUTF_7_c: { bom: [0x2B, 0x2F, 0x76, 0x2B], encoding: "" },
    bomUTF_7_d: { bom: [0x2B, 0x2F, 0x76, 0x2F], encoding: "" },
    bomUTF_7_e: { bom: [0x2B, 0x2F, 0x76, 0x38, 0x2D], encoding: "" },
    bomUTF_1: { bom: [0xF7, 0x64, 0x4C], encoding: "" },
    bomUTF_EBCDIC: { bom: [0xDD, 0x73, 0x66, 0x73], encoding: "" },
    bomSCSU: { bom: [0x0E, 0xFE, 0xFF], encoding: "" },
    bomBOCU_1: { bom: [0xFB, 0xEE, 0x28], encoding: "" },
    bomGB_18030: { bom: [0x84, 0x31, 0x95, 0x33], encoding: "" },
};
let maxBomLength = 0;
for (let bomMapItemName in bomMap) {
    let bomMapItem = bomMap[bomMapItemName];
    maxBomLength = Math.max(maxBomLength, bomMapItem.bom.length);
}
function isBomMatch(mapItem, bom) {
    if (bom.length < mapItem.bom.length) {
        return false;
    }
    for (let i = 0; i < mapItem.bom.length; i++) {
        if (bom[i] != mapItem.bom[i]) {
            return false;
        }
    }
    return true;
}
// TODO: share these, or try fs-promise (or similar)
function fileStat(path) {
    return new Promise(function (resolve, reject) {
        fs.stat(path, function (err, stats) {
            if ((null !== err) && (undefined !== err)) {
                reject(err);
            }
            else {
                resolve(stats);
            }
        });
    });
}
function openFile(path, flags) {
    return new Promise(function (resolve, reject) {
        fs.open(path, flags, function (err, fd) {
            if ((null !== err) && (undefined !== err)) {
                reject(err);
            }
            else {
                resolve(fd);
            }
        });
    });
}
function readFile(fd, buffer, offset, length, position) {
    return new Promise(function (resolve, reject) {
        fs.read(fd, buffer, offset, length, position, function (err, bytesRead, buffer) {
            if ((null !== err) && (undefined !== err)) {
                reject(err);
            }
            else {
                resolve({ bytesRead: bytesRead, buffer: buffer });
            }
        });
    });
}
function closeFile(fd) {
    return new Promise(function (resolve, reject) {
        fs.close(fd, function (err) {
            if ((null !== err) && (undefined !== err)) {
                reject(err);
            }
            else {
                resolve();
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZC10ZXh0LWZpbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcmVhZC10ZXh0LWZpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsTUFBWSxFQUFFLFdBQU0sSUFBSSxDQUFDLENBQUE7QUFHekIsaUNBQThCLGdCQUFnQixDQUFDLENBQUE7QUFFL0MsY0FBMkIsSUFBWTs7UUFFdEMsSUFBSSxJQUFJLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFaEMsSUFBSSxFQUFFLEdBQVcsSUFBSSxDQUFDO1FBQ3RCLElBQUksTUFBYyxDQUFDO1FBRW5CLElBQ0EsQ0FBQztZQUNBLEVBQUUsR0FBRyxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFL0IsSUFBSSxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDdEMsSUFBSSxhQUFhLEdBQUcsTUFBTSxRQUFRLENBQUMsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBRW5FLElBQUksWUFBWSxHQUFHLGVBQWUsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFekQsSUFBSSxPQUFPLEdBQUcsSUFBSSw4QkFBYSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUV2RCxJQUFJLFVBQVUsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDO1lBQ3hDLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQztZQUVsRCxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDOUIsSUFBSSxjQUFjLEdBQUcsTUFBTSxRQUFRLENBQUMsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUVy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QUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBZ0I7SUFDekUsVUFBVSxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBRS9FLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBZ0I7SUFFakUsYUFBYSxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBZ0I7SUFFNUUsT0FBTyxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFnQjtJQUVoRSxTQUFTLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBRWxFLFdBQVcsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0NBQzFFLENBQUM7QUFFSCxJQUFJLFlBQVksR0FBVyxDQUFDLENBQUM7QUFFN0IsR0FBRyxDQUFDLENBQUMsSUFBSSxjQUFjLElBQUksTUFBTSxDQUFDLENBQ2xDLENBQUM7SUFDQSxJQUFJLFVBQVUsR0FBSSxNQUFjLENBQUMsY0FBYyxDQUFlLENBQUM7SUFDL0QsWUFBWSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLFVBQVUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFD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S0FBSyxDQUNQLEVBQUUsRUFDRixVQUFVLEdBQUc7WUFFWixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUMxQyxDQUFDO2dCQUNBLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNiLENBQUM7WUFDRCxJQUFJLENBQ0osQ0FBQztnQkFDQSxPQUFPLEVBQUUsQ0FBQztZQUNYLENBQUM7UUFDRixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuXG5pbXBvcnQgeyBTdHJpbmdEZWNvZGVyIH0gZnJvbSBcInN0cmluZ19kZWNvZGVyXCI7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWFkKHBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPlxue1xuXHRsZXQgc3RhdCA9IGF3YWl0IGZpbGVTdGF0KHBhdGgpO1xuXG5cdGxldCBmZDogbnVtYmVyID0gbnVsbDtcblx0bGV0IHJlc3VsdDogc3RyaW5nO1xuXG5cdHRyeVxuXHR7XG5cdFx0ZmQgPSBhd2FpdCBvcGVuRmlsZShwYXRoLCBcInJcIik7XG5cblx0XHRsZXQgYnVmZmVyID0gbmV3IEJ1ZmZlcihtYXhCb21MZW5ndGgpO1xuXHRcdGxldCByZWFkQm9tUmVzdWx0ID0gYXdhaXQgcmVhZEZpbGUoZmQsIGJ1ZmZlciwgMCwgbWF4Qm9tTGVuZ3RoLCAwKTtcblxuXHRcdGxldCBlbmNvZGluZ0luZm8gPSBnZXRFbmNvZGluZ0luZm8ocmVhZEJvbVJlc3VsdC5idWZmZXIpO1xuXG5cdFx0bGV0IGRlY29kZXIgPSBuZXcgU3RyaW5nRGVjb2RlcihlbmNvZGluZ0luZm8uZW5jb2RpbmcpO1xuXG5cdFx0bGV0IHRleHRPZmZzZXQgPSBlbmNvZGluZ0luZm8uYm9tTGVuZ3RoO1xuXHRcdGxldCB0ZXh0U2l6ZSA9IHN0YXQuc2l6ZSAtIGVuY29kaW5nSW5mby5ib21MZW5ndGg7XG5cblx0XHRidWZmZXIgPSBuZXcgQnVmZmVyKHRleHRTaXplKTtcblx0XHRsZXQgcmVhZEZpbGVSZXN1bHQgPSBhd2FpdCByZWFkRmlsZShmZCwgYnVmZmVyLCAwLCB0ZXh0U2l6ZSwgZW5jb2RpbmdJbmZvLmJvbUxlbmd0aCk7XG5cblx0XHRyZXN1bHQgPSBkZWNvZGVyLndyaXRlKHJlYWRGaWxlUmVzdWx0LmJ1ZmZlcik7XG5cdH1cblx0ZmluYWxseVxuXHR7XG5cdFx0aWYgKChmZCAhPT0gbnVsbCkgJiYgKGZkICE9PSB1bmRlZmluZWQpKVxuXHRcdHtcblx0XHRcdGF3YWl0IGNsb3NlRmlsZShmZCk7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHJlc3VsdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRTeW5jKHBhdGg6IHN0cmluZyk6IHN0cmluZ1xue1xuXHRsZXQgc3RhdCA9IGZzLnN0YXRTeW5jKHBhdGgpO1xuXG5cdGxldCBmZDogbnVtYmVyID0gbnVsbDtcblx0bGV0IHJlc3VsdDogc3RyaW5nO1xuXG5cdHRyeVxuXHR7XG5cdFx0ZmQgPSBmcy5vcGVuU3luYyhwYXRoLCBcInJcIik7XG5cblx0XHRsZXQgYnVmZmVyID0gbmV3IEJ1ZmZlcihtYXhCb21MZW5ndGgpO1xuXHRcdGZzLnJlYWRTeW5jKGZkLCBidWZmZXIsIDAsIG1heEJvbUxlbmd0aCwgMCk7XG5cblx0XHRsZXQgZW5jb2RpbmdJbmZvID0gZ2V0RW5jb2RpbmdJbmZvKGJ1ZmZlcik7XG5cblx0XHRsZXQgZGVjb2RlciA9IG5ldyBTdHJpbmdEZWNvZGVyKGVuY29kaW5nSW5mby5lbmNvZGluZyk7XG5cblx0XHRsZXQgdGV4dE9mZnNldCA9IGVuY29kaW5nSW5mby5ib21MZW5ndGg7XG5cdFx0bGV0IHRleHRTaXplID0gc3RhdC5zaXplIC0gZW5jb2RpbmdJbmZvLmJvbUxlbmd0aDtcblxuXHRcdGJ1ZmZlciA9IG5ldyBCdWZmZXIodGV4dFNpemUpO1xuXHRcdGZzLnJlYWRTeW5jKGZkLCBidWZmZXIsIDAsIHRleHRTaXplLCBlbmNvZGluZ0luZm8uYm9tTGVuZ3RoKTtcblxuXHRcdHJlc3VsdCA9IGRlY29kZXIud3JpdGUoYnVmZmVyKTtcblx0fVxuXHRmaW5hbGx5XG5cdHtcblx0XHRpZiAoKGZkICE9PSBudWxsKSAmJiAoZmQgIT09IHVuZGVmaW5lZCkpXG5cdFx0e1xuXHRcdFx0ZnMuY2xvc2VTeW5jKGZkKTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gcmVzdWx0O1xufVxuXG5pbnRlcmZhY2UgRW5jb2RpbmdJbmZvXG57XG5cdGVuY29kaW5nOiBzdHJpbmc7XG5cdGJvbUxlbmd0aDogbnVtYmVyO1xufVxuXG5mdW5jdGlvbiBnZXRFbmNvZGluZ0luZm8oYnVmZmVyOiBCdWZmZXIpOiBFbmNvZGluZ0luZm9cbntcblx0bGV0IGVuY29kaW5nID0gZGVmYXVsdFRleHRGaWxlRW5jb2Rpbmc7XG5cdGxldCBib21MZW5ndGggPSAwO1xuXG5cdGZvciAobGV0IGJvbU1hcEl0ZW1OYW1lIGluIGJvbU1hcClcblx0e1xuXHRcdGxldCBib21NYXBJdGVtID0gKGJvbU1hcCBhcyBhbnkpW2JvbU1hcEl0ZW1OYW1lXSBhcyBCb21NYXBJdGVtO1xuXG5cdFx0aWYgKGlzQm9tTWF0Y2goYm9tTWFwSXRlbSwgYnVmZmVyKSlcblx0XHR7XG5cdFx0XHRpZiAoKHR5cGVvZiAoYm9tTWFwSXRlbS5lbmNvZGluZykgIT09IFwic3RyaW5nXCIpKVxuXHRcdFx0e1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJVbnN1cHBvcnRlZCB0ZXh0IGZpbGUgZW5jb2RpbmdcIik7XG5cdFx0XHR9XG5cblx0XHRcdGJvbUxlbmd0aCA9IGJvbU1hcEl0ZW0uYm9tLmxlbmd0aDtcblx0XHRcdGVuY29kaW5nID0gYm9tTWFwSXRlbS5lbmNvZGluZztcblxuXHRcdFx0YnJlYWs7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHsgZW5jb2Rpbmc6IGVuY29kaW5nLCBib21MZW5ndGg6IGJvbUxlbmd0aCB9O1xufVxuXG5pbnRlcmZhY2UgQm9tTWFwSXRlbVxue1xuXHRib206IG51bWJlcltdO1xuXHRlbmNvZGluZzogc3RyaW5nO1xufVxuXG5jb25zdCB1dGY4RmlsZVRleHRFbmNvZGluZyA9IFwidXRmLThcIjtcbmNvbnN0IGRlZmF1bHRUZXh0RmlsZUVuY29kaW5nID0gdXRmOEZpbGVUZXh0RW5jb2Rpbmc7XG5cbmxldCBib21NYXAgPVxuXHR7XG5cdFx0Ym9tVVRGXzg6IHsgYm9tOiBbMHhFRiwgMHhCQiwgMHhCRl0sIGVuY29kaW5nOiB1dGY4RmlsZVRleHRFbmNvZGluZyB9IGFzIEJvbU1hcEl0ZW0sXG5cblx0XHRib21VVEZfMTZfQkU6IHsgYm9tOiBbMHhGRSwgMHhGRl0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblx0XHRib21VVEZfMTZfTEU6IHsgYm9tOiBbMHhGRiwgMHhGRV0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbVVURl8zMl9CRTogeyBib206IFsweDAwLCAweDAwLCAweEZFLCAweEZGXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXHRcdGJvbVVURl8zMl9MRTogeyBib206IFsweEZGLCAweEZFLCAweDAwLCAweDAwXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tVVRGXzdfYTogeyBib206IFsweDJCLCAweDJGLCAweDc2LCAweDM4XSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXHRcdGJvbVVURl83X2I6IHsgYm9tOiBbMHgyQiwgMHgyRiwgMHg3NiwgMHgzOV0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblx0XHRib21VVEZfN19jOiB7IGJvbTogWzB4MkIsIDB4MkYsIDB4NzYsIDB4MkJdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cdFx0Ym9tVVRGXzdfZDogeyBib206IFsweDJCLCAweDJGLCAweDc2LCAweDJGXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXHRcdGJvbVVURl83X2U6IHsgYm9tOiBbMHgyQiwgMHgyRiwgMHg3NiwgMHgzOCwgMHgyRF0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbVVURl8xOiB7IGJvbTogWzB4RjcsIDB4NjQsIDB4NENdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cblx0XHRib21VVEZfRUJDRElDOiB7IGJvbTogWzB4REQsIDB4NzMsIDB4NjYsIDB4NzNdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cblx0XHRib21TQ1NVOiB7IGJvbTogWzB4MEUsIDB4RkUsIDB4RkZdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cblx0XHRib21CT0NVXzE6IHsgYm9tOiBbMHhGQiwgMHhFRSwgMHgyOF0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbUdCXzE4MDMwOiB7IGJvbTogWzB4ODQsIDB4MzEsIDB4OTUsIDB4MzNdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cdH07XG5cbmxldCBtYXhCb21MZW5ndGg6IG51bWJlciA9IDA7XG5cbmZvciAobGV0IGJvbU1hcEl0ZW1OYW1lIGluIGJvbU1hcClcbntcblx0bGV0IGJvbU1hcEl0ZW0gPSAoYm9tTWFwIGFzIGFueSlbYm9tTWFwSXRlbU5hbWVdIGFzIEJvbU1hcEl0ZW07XG5cdG1heEJvbUxlbmd0aCA9IE1hdGgubWF4KG1heEJvbUxlbmd0aCwgYm9tTWFwSXRlbS5ib20ubGVuZ3RoKTtcbn1cblxuZnVuY3Rpb24gaXNCb21NYXRjaChtYXBJdGVtOiBCb21NYXBJdGVtLCBib206IEJ1ZmZlcilcbntcblx0aWYgKGJvbS5sZW5ndGggPCBtYXBJdGVtLmJvbS5sZW5ndGgpXG5cdHtcblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cblxuXHRmb3IgKGxldCBpID0gMDsgaSA8IG1hcEl0ZW0uYm9tLmxlbmd0aDsgaSsrKVxuXHR7XG5cdFx0aWYgKGJvbVtpXSAhPSBtYXBJdGVtLmJvbVtpXSlcblx0XHR7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHRydWU7XG59XG5cbi8vIFRPRE86IHNoYXJlIHRoZXNlLCBvciB0cnkgZnMtcHJvbWlzZSAob3Igc2ltaWxhcilcbmZ1bmN0aW9uIGZpbGVTdGF0KHBhdGg6IHN0cmluZyB8IEJ1ZmZlcik6IFByb21pc2U8ZnMuU3RhdHM+XG57XG5cdHJldHVybiBuZXcgUHJvbWlzZTxmcy5TdGF0cz4oXG5cdFx0ZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdClcblx0XHR7XG5cdFx0XHRmcy5zdGF0KFxuXHRcdFx0XHRwYXRoLFxuXHRcdFx0XHRmdW5jdGlvbiAoZXJyLCBzdGF0cylcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGlmICgobnVsbCAhPT0gZXJyKSAmJiAodW5kZWZpbmVkICE9PSBlcnIpKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlamVjdChlcnIpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVzb2x2ZShzdGF0cyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHR9KTtcbn1cblxuZnVuY3Rpb24gb3BlbkZpbGUocGF0aDogc3RyaW5nIHwgQnVmZmVyLCBmbGFnczogc3RyaW5nIHwgbnVtYmVyKTogUHJvbWlzZTxudW1iZXI+XG57XG5cdHJldHVybiBuZXcgUHJvbWlzZTxudW1iZXI+KFxuXHRcdGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpXG5cdFx0e1xuXHRcdFx0ZnMub3Blbihcblx0XHRcdFx0cGF0aCxcblx0XHRcdFx0ZmxhZ3MsXG5cdFx0XHRcdGZ1bmN0aW9uIChlcnIsIGZkKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKChudWxsICE9PSBlcnIpICYmICh1bmRlZmluZWQgIT09IGVycikpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVqZWN0KGVycik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZXNvbHZlKGZkKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdH0pO1xufVxuXG5pbnRlcmZhY2UgUmVhZEZpbGVSZXN1bHRcbntcblx0Ynl0ZXNSZWFkOiBudW1iZXI7XG5cdGJ1ZmZlcjogQnVmZmVyO1xufVxuXG5mdW5jdGlvbiByZWFkRmlsZShmZDogbnVtYmVyLCBidWZmZXI6IEJ1ZmZlciwgb2Zmc2V0OiBudW1iZXIsIGxlbmd0aDogbnVtYmVyLCBwb3NpdGlvbjogbnVtYmVyKTogUHJvbWlzZTxSZWFkRmlsZVJlc3VsdD5cbntcblx0cmV0dXJuIG5ldyBQcm9taXNlPFJlYWRGaWxlUmVzdWx0Pihcblx0XHRmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KVxuXHRcdHtcblx0XHRcdGZzLnJlYWQoXG5cdFx0XHRcdGZkLFxuXHRcdFx0XHRidWZmZXIsXG5cdFx0XHRcdG9mZnNldCxcblx0XHRcdFx0bGVuZ3RoLFxuXHRcdFx0XHRwb3NpdGlvbixcblx0XHRcdFx0ZnVuY3Rpb24gKGVyciwgYnl0ZXNSZWFkLCBidWZmZXIpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRpZiAoKG51bGwgIT09IGVycikgJiYgKHVuZGVmaW5lZCAhPT0gZXJyKSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlc29sdmUoeyBieXRlc1JlYWQ6IGJ5dGVzUmVhZCwgYnVmZmVyOiBidWZmZXIgfSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHR9KTtcbn1cblxuZnVuY3Rpb24gY2xvc2VGaWxlKGZkOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+XG57XG5cdHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPihcblx0XHRmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KVxuXHRcdHtcblx0XHRcdGZzLmNsb3NlKFxuXHRcdFx0XHRmZCxcblx0XHRcdFx0ZnVuY3Rpb24gKGVycilcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGlmICgobnVsbCAhPT0gZXJyKSAmJiAodW5kZWZpbmVkICE9PSBlcnIpKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlamVjdChlcnIpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVzb2x2ZSgpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0fSk7XG59Il19