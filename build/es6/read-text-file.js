"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
const fs = require("fs");
const string_decoder_1 = require("string_decoder");
function readTextFile(path) {
    return __awaiter(this, void 0, void 0, function* () {
        let stat = yield fileStat(path);
        let fd = null;
        let result;
        try {
            fd = yield openFile(path, "r");
            let buffer = new Buffer(maxBomLength);
            let readBomResult = yield readFile(fd, buffer, 0, maxBomLength, 0);
            let encodingInfo = getEncodingInfo(readBomResult.buffer);
            let decoder = new string_decoder_1.StringDecoder(encodingInfo.encoding);
            let textOffset = encodingInfo.bomLength;
            let textSize = stat.size - encodingInfo.bomLength;
            buffer = new Buffer(textSize);
            let readFileResult = yield readFile(fd, buffer, 0, textSize, encodingInfo.bomLength);
            result = decoder.write(readFileResult.buffer);
        }
        finally {
            if ((fd !== null) && (fd !== undefined)) {
                yield closeFile(fd);
            }
        }
        return result;
    });
}
exports.readTextFile = readTextFile;
function readTextFileSync(path) {
    let stat = fs.statSync(path);
    let fd = null;
    let result;
    try {
        fd = fs.openSync(path, "r");
        let buffer = new Buffer(maxBomLength);
        fs.readSync(fd, buffer, 0, maxBomLength, 0);
        let encodingInfo = getEncodingInfo(buffer);
        let decoder = new string_decoder_1.StringDecoder(encodingInfo.encoding);
        let textOffset = encodingInfo.bomLength;
        let textSize = stat.size - encodingInfo.bomLength;
        buffer = new Buffer(textSize);
        fs.readSync(fd, buffer, 0, textSize, encodingInfo.bomLength);
        result = decoder.write(buffer);
    }
    finally {
        if ((fd !== null) && (fd !== undefined)) {
            fs.closeSync(fd);
        }
    }
    return result;
}
exports.readTextFileSync = readTextFileSync;
function getEncodingInfo(buffer) {
    let encoding = defaultTextFileEncoding;
    let bomLength = 0;
    for (let bomMapItemName in bomMap) {
        let bomMapItem = bomMap[bomMapItemName];
        if (isBomMatch(bomMapItem, buffer)) {
            if ((typeof (bomMapItem.encoding) !== "string")) {
                throw new Error("Unsupported text file encoding");
            }
            bomLength = bomMapItem.bom.length;
            encoding = bomMapItem.encoding;
            break;
        }
    }
    return { encoding: encoding, bomLength: bomLength };
}
const utf8FileTextEncoding = "utf-8";
const defaultTextFileEncoding = utf8FileTextEncoding;
let bomMap = {
    bomUTF_8: { bom: [0xEF, 0xBB, 0xBF], encoding: utf8FileTextEncoding },
    bomUTF_16_BE: { bom: [0xFE, 0xFF], encoding: "" },
    bomUTF_16_LE: { bom: [0xFF, 0xFE], encoding: "" },
    bomUTF_32_BE: { bom: [0x00, 0x00, 0xFE, 0xFF], encoding: "" },
    bomUTF_32_LE: { bom: [0xFF, 0xFE, 0x00, 0x00], encoding: "" },
    bomUTF_7_a: { bom: [0x2B, 0x2F, 0x76, 0x38], encoding: "" },
    bomUTF_7_b: { bom: [0x2B, 0x2F, 0x76, 0x39], encoding: "" },
    bomUTF_7_c: { bom: [0x2B, 0x2F, 0x76, 0x2B], encoding: "" },
    bomUTF_7_d: { bom: [0x2B, 0x2F, 0x76, 0x2F], encoding: "" },
    bomUTF_7_e: { bom: [0x2B, 0x2F, 0x76, 0x38, 0x2D], encoding: "" },
    bomUTF_1: { bom: [0xF7, 0x64, 0x4C], encoding: "" },
    bomUTF_EBCDIC: { bom: [0xDD, 0x73, 0x66, 0x73], encoding: "" },
    bomSCSU: { bom: [0x0E, 0xFE, 0xFF], encoding: "" },
    bomBOCU_1: { bom: [0xFB, 0xEE, 0x28], encoding: "" },
    bomGB_18030: { bom: [0x84, 0x31, 0x95, 0x33], encoding: "" },
};
let maxBomLength = 0;
for (let bomMapItemName in bomMap) {
    let bomMapItem = bomMap[bomMapItemName];
    maxBomLength = Math.max(maxBomLength, bomMapItem.bom.length);
}
function isBomMatch(mapItem, bom) {
    if (bom.length < mapItem.bom.length) {
        return false;
    }
    for (let i = 0; i < mapItem.bom.length; i++) {
        if (bom[i] != mapItem.bom[i]) {
            return false;
        }
    }
    return true;
}
// TODO: share these, or try fs-promise (or similar)
function fileStat(path) {
    return new Promise(function (resolve, reject) {
        fs.stat(path, function (err, stats) {
            if ((null !== err) && (undefined !== err)) {
                reject(err);
            }
            else {
                resolve(stats);
            }
        });
    });
}
function openFile(path, flags) {
    return new Promise(function (resolve, reject) {
        fs.open(path, flags, function (err, fd) {
            if ((null !== err) && (undefined !== err)) {
                reject(err);
            }
            else {
                resolve(fd);
            }
        });
    });
}
function readFile(fd, buffer, offset, length, position) {
    return new Promise(function (resolve, reject) {
        fs.read(fd, buffer, offset, length, position, function (err, bytesRead, buffer) {
            if ((null !== err) && (undefined !== err)) {
                reject(err);
            }
            else {
                resolve({ bytesRead: bytesRead, buffer: buffer });
            }
        });
    });
}
function closeFile(fd) {
    return new Promise(function (resolve, reject) {
        fs.close(fd, function (err) {
            if ((null !== err) && (undefined !== err)) {
                reject(err);
            }
            else {
                resolve();
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhZC10ZXh0LWZpbGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcmVhZC10ZXh0LWZpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsTUFBWSxFQUFFLFdBQU0sSUFBSSxDQUFDLENBQUE7QUFHekIsaUNBQThCLGdCQUFnQixDQUFDLENBQUE7QUFFL0Msc0JBQW1DLElBQVk7O1FBRTlDLElBQUksSUFBSSxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWhDLElBQUksRUFBRSxHQUFXLElBQUksQ0FBQztRQUN0QixJQUFJLE1BQWMsQ0FBQztRQUVuQixJQUNBLENBQUM7WUFDQSxFQUFFLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBRS9CLElBQUksTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3RDLElBQUksYUFBYSxHQUFHLE1BQU0sUUFBUSxDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQztZQUVuRSxJQUFJLFlBQVksR0FBRyxlQUFlLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXpELElBQUksT0FBTyxHQUFHLElBQUksOEJBQWEsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFdkQsSUFBSSxVQUFVLEdBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQztZQUN4QyxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUM7WUFFbEQsTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzlCLElBQUksY0FBYyxHQUFHLE1BQU0sUUFBUSxDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFckYsTUFBTSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9DLENBQUM7Z0JBRUQsQ0FBQztZQUNBLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQ3hDLENBQUM7Z0JBQ0EsTUFBTSxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDckIsQ0FBQztRQUNGLENBQUM7UUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ2YsQ0FBQzs7QUFuQ3FCLG9CQUFZLGVBbUNqQyxDQUFBO0FBRUQsMEJBQWlDLElBQVk7SUFFNUMsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUU3QixJQUFJLEVBQUUsR0FBVyxJQUFJLENBQUM7SUFDdEIsSUFBSSxNQUFjLENBQUM7SUFFbkIsSUFDQSxDQUFDO1FBQ0EsRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRTVCLElBQUksTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3RDLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRTVDLElBQUksWUFBWSxHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUUzQyxJQUFJLE9BQU8sR0FBRyxJQUFJLDhCQUFhLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXZELElBQUksVUFBVSxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUM7UUFDeEMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDO1FBRWxELE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM5QixFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFN0QsTUFBTSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDaEMsQ0FBQztZQUVELENBQUM7UUFDQSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUN4QyxDQUFDO1lBQ0EsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsQixDQUFDO0lBQ0YsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFNLENBQUM7QUFDZixDQUFDO0FBbkNlLHdCQUFnQixtQkFtQy9CLENBQUE7QUFRRCx5QkFBeUIsTUFBYztJQUV0QyxJQUFJLFFBQVEsR0FBRyx1QkFBdUIsQ0FBQztJQUN2QyxJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7SUFFbEIsR0FBRyxDQUFDLENBQUMsSUFBSSxjQUFjLElBQUksTUFBTSxDQUFDLENBQ2xDLENBQUM7UUFDQSxJQUFJLFVBQVUsR0FBSSxNQUFjLENBQUMsY0FBYyxDQUFlLENBQUM7UUFFL0QsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUNuQyxDQUFDO1lBQ0EsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQ2hELENBQUM7Z0JBQ0EsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1lBQ25ELENBQUM7WUFFRCxTQUFTLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7WUFDbEMsUUFBUSxHQUFHLFVBQVUsQ0FBQyxRQUFRLENBQUM7WUFFL0IsS0FBSyxDQUFDO1FBQ1AsQ0FBQztJQUNGLENBQUM7SUFFRCxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsQ0FBQztBQUNyRCxDQUFDO0FBUUQsTUFBTSxvQkFBb0IsR0FBRyxPQUFPLENBQUM7QUFDckMsTUFBTSx1QkFBdUIsR0FBRyxvQkFBb0IsQ0FBQztBQUVyRCxJQUFJLE1BQU0sR0FDVDtJQUNDLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLG9CQUFvQixFQUFnQjtJQUVuRixZQUFZLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBZ0I7SUFDL0QsWUFBWSxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBRS9ELFlBQVksRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBQzNFLFlBQVksRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBRTNFLFVBQVUsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBQ3pFLFVBQVUsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBQ3pFLFVBQVUsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBQ3pFLFVBQVUsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBQ3pFLFVBQVUsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFnQjtJQUUvRSxRQUFRLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBRWpFLGFBQWEsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQWdCO0lBRTVFLE9BQU8sRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBZ0I7SUFFaEUsU0FBUyxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFnQjtJQUVsRSxXQUFXLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFnQjtDQUMxRSxDQUFDO0FBRUgsSUFBSSxZQUFZLEdBQVcsQ0FBQyxDQUFDO0FBRTdCLEdBQUcsQ0FBQyxDQUFDLElBQUksY0FBYyxJQUFJLE1BQU0sQ0FBQyxDQUNsQyxDQUFDO0lBQ0EsSUFBSSxVQUFVLEdBQUksTUFBYyxDQUFDLGNBQWMsQ0FBZSxDQUFDO0lBQy9ELFlBQVksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxVQUFVLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzlELENBQUM7QUFFRCxvQkFBb0IsT0FBbUIsRUFBRSxHQUFXO0lBRW5ELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FDcEMsQ0FBQztRQUNBLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDZCxDQUFDO0lBRUQsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFDM0MsQ0FBQztRQUNBLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQzdCLENBQUM7WUFDQSxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2QsQ0FBQztJQUNGLENBQUM7SUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDO0FBQ2IsQ0FBQztBQUVELG9EQUFvRDtBQUNwRCxrQkFBa0IsSUFBcUI7SUFFdEMsTUFBTSxDQUFDLElBQUksT0FBTyxDQUNqQixVQUFVLE9BQU8sRUFBRSxNQUFNO1FBRXhCLEVBQUUsQ0FBQyxJQUFJLENBQ04sSUFBSSxFQUNKLFVBQVUsR0FBRyxFQUFFLEtBQUs7WUFFbkIsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FDMUMsQ0FBQztnQkFDQSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDYixDQUFDO1lBQ0QsSUFBSSxDQUNKLENBQUM7Z0JBQ0EsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2hCLENBQUM7UUFDRixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELGtCQUFrQixJQUFxQixFQUFFLEtBQXNCO0lBRTlELE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FDakIsVUFBVSxPQUFPLEVBQUUsTUFBTTtRQUV4QixFQUFFLENBQUMsSUFBSSxDQUNOLElBQUksRUFDSixLQUFLLEVBQ0wsVUFBVSxHQUFHLEVBQUUsRUFBRTtZQUVoQixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUMxQyxDQUFDO2dCQUNBLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNiLENBQUM7WUFDRCxJQUFJLENBQ0osQ0FBQztnQkFDQSxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDYixDQUFDO1FBQ0YsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFRRCxrQkFBa0IsRUFBVSxFQUFFLE1BQWMsRUFBRSxNQUFjLEVBQUUsTUFBYyxFQUFFLFFBQWdCO0lBRTdGLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FDakIsVUFBVSxPQUFPLEVBQUUsTUFBTTtRQUV4QixFQUFFLENBQUMsSUFBSSxDQUNOLEVBQUUsRUFDRixNQUFNLEVBQ04sTUFBTSxFQUNOLE1BQU0sRUFDTixRQUFRLEVBQ1IsVUFBVSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU07WUFFL0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FDMUMsQ0FBQztnQkFDQSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDYixDQUFDO1lBQ0QsSUFBSSxDQUNKLENBQUM7Z0JBQ0EsT0FBTyxDQUFDLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUNuRCxDQUFDO1FBQ0YsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxtQkFBbUIsRUFBVTtJQUU1QixNQUFNLENBQUMsSUFBSSxPQUFPLENBQ2pCLFVBQVUsT0FBTyxFQUFFLE1BQU07UUFFeEIsRUFBRSxDQUFDLEtBQUssQ0FDUCxFQUFFLEVBQ0YsVUFBVSxHQUFHO1lBRVosRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FDMUMsQ0FBQztnQkFDQSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDYixDQUFDO1lBQ0QsSUFBSSxDQUNKLENBQUM7Z0JBQ0EsT0FBTyxFQUFFLENBQUM7WUFDWCxDQUFDO1FBQ0YsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcblxuaW1wb3J0IHsgU3RyaW5nRGVjb2RlciB9IGZyb20gXCJzdHJpbmdfZGVjb2RlclwiO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVhZFRleHRGaWxlKHBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPlxue1xuXHRsZXQgc3RhdCA9IGF3YWl0IGZpbGVTdGF0KHBhdGgpO1xuXG5cdGxldCBmZDogbnVtYmVyID0gbnVsbDtcblx0bGV0IHJlc3VsdDogc3RyaW5nO1xuXG5cdHRyeVxuXHR7XG5cdFx0ZmQgPSBhd2FpdCBvcGVuRmlsZShwYXRoLCBcInJcIik7XG5cblx0XHRsZXQgYnVmZmVyID0gbmV3IEJ1ZmZlcihtYXhCb21MZW5ndGgpO1xuXHRcdGxldCByZWFkQm9tUmVzdWx0ID0gYXdhaXQgcmVhZEZpbGUoZmQsIGJ1ZmZlciwgMCwgbWF4Qm9tTGVuZ3RoLCAwKTtcblxuXHRcdGxldCBlbmNvZGluZ0luZm8gPSBnZXRFbmNvZGluZ0luZm8ocmVhZEJvbVJlc3VsdC5idWZmZXIpO1xuXG5cdFx0bGV0IGRlY29kZXIgPSBuZXcgU3RyaW5nRGVjb2RlcihlbmNvZGluZ0luZm8uZW5jb2RpbmcpO1xuXG5cdFx0bGV0IHRleHRPZmZzZXQgPSBlbmNvZGluZ0luZm8uYm9tTGVuZ3RoO1xuXHRcdGxldCB0ZXh0U2l6ZSA9IHN0YXQuc2l6ZSAtIGVuY29kaW5nSW5mby5ib21MZW5ndGg7XG5cblx0XHRidWZmZXIgPSBuZXcgQnVmZmVyKHRleHRTaXplKTtcblx0XHRsZXQgcmVhZEZpbGVSZXN1bHQgPSBhd2FpdCByZWFkRmlsZShmZCwgYnVmZmVyLCAwLCB0ZXh0U2l6ZSwgZW5jb2RpbmdJbmZvLmJvbUxlbmd0aCk7XG5cblx0XHRyZXN1bHQgPSBkZWNvZGVyLndyaXRlKHJlYWRGaWxlUmVzdWx0LmJ1ZmZlcik7XG5cdH1cblx0ZmluYWxseVxuXHR7XG5cdFx0aWYgKChmZCAhPT0gbnVsbCkgJiYgKGZkICE9PSB1bmRlZmluZWQpKVxuXHRcdHtcblx0XHRcdGF3YWl0IGNsb3NlRmlsZShmZCk7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHJlc3VsdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRUZXh0RmlsZVN5bmMocGF0aDogc3RyaW5nKTogc3RyaW5nXG57XG5cdGxldCBzdGF0ID0gZnMuc3RhdFN5bmMocGF0aCk7XG5cblx0bGV0IGZkOiBudW1iZXIgPSBudWxsO1xuXHRsZXQgcmVzdWx0OiBzdHJpbmc7XG5cblx0dHJ5XG5cdHtcblx0XHRmZCA9IGZzLm9wZW5TeW5jKHBhdGgsIFwiclwiKTtcblxuXHRcdGxldCBidWZmZXIgPSBuZXcgQnVmZmVyKG1heEJvbUxlbmd0aCk7XG5cdFx0ZnMucmVhZFN5bmMoZmQsIGJ1ZmZlciwgMCwgbWF4Qm9tTGVuZ3RoLCAwKTtcblxuXHRcdGxldCBlbmNvZGluZ0luZm8gPSBnZXRFbmNvZGluZ0luZm8oYnVmZmVyKTtcblxuXHRcdGxldCBkZWNvZGVyID0gbmV3IFN0cmluZ0RlY29kZXIoZW5jb2RpbmdJbmZvLmVuY29kaW5nKTtcblxuXHRcdGxldCB0ZXh0T2Zmc2V0ID0gZW5jb2RpbmdJbmZvLmJvbUxlbmd0aDtcblx0XHRsZXQgdGV4dFNpemUgPSBzdGF0LnNpemUgLSBlbmNvZGluZ0luZm8uYm9tTGVuZ3RoO1xuXG5cdFx0YnVmZmVyID0gbmV3IEJ1ZmZlcih0ZXh0U2l6ZSk7XG5cdFx0ZnMucmVhZFN5bmMoZmQsIGJ1ZmZlciwgMCwgdGV4dFNpemUsIGVuY29kaW5nSW5mby5ib21MZW5ndGgpO1xuXG5cdFx0cmVzdWx0ID0gZGVjb2Rlci53cml0ZShidWZmZXIpO1xuXHR9XG5cdGZpbmFsbHlcblx0e1xuXHRcdGlmICgoZmQgIT09IG51bGwpICYmIChmZCAhPT0gdW5kZWZpbmVkKSlcblx0XHR7XG5cdFx0XHRmcy5jbG9zZVN5bmMoZmQpO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiByZXN1bHQ7XG59XG5cbmludGVyZmFjZSBFbmNvZGluZ0luZm9cbntcblx0ZW5jb2Rpbmc6IHN0cmluZztcblx0Ym9tTGVuZ3RoOiBudW1iZXI7XG59XG5cbmZ1bmN0aW9uIGdldEVuY29kaW5nSW5mbyhidWZmZXI6IEJ1ZmZlcik6IEVuY29kaW5nSW5mb1xue1xuXHRsZXQgZW5jb2RpbmcgPSBkZWZhdWx0VGV4dEZpbGVFbmNvZGluZztcblx0bGV0IGJvbUxlbmd0aCA9IDA7XG5cblx0Zm9yIChsZXQgYm9tTWFwSXRlbU5hbWUgaW4gYm9tTWFwKVxuXHR7XG5cdFx0bGV0IGJvbU1hcEl0ZW0gPSAoYm9tTWFwIGFzIGFueSlbYm9tTWFwSXRlbU5hbWVdIGFzIEJvbU1hcEl0ZW07XG5cblx0XHRpZiAoaXNCb21NYXRjaChib21NYXBJdGVtLCBidWZmZXIpKVxuXHRcdHtcblx0XHRcdGlmICgodHlwZW9mIChib21NYXBJdGVtLmVuY29kaW5nKSAhPT0gXCJzdHJpbmdcIikpXG5cdFx0XHR7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihcIlVuc3VwcG9ydGVkIHRleHQgZmlsZSBlbmNvZGluZ1wiKTtcblx0XHRcdH1cblxuXHRcdFx0Ym9tTGVuZ3RoID0gYm9tTWFwSXRlbS5ib20ubGVuZ3RoO1xuXHRcdFx0ZW5jb2RpbmcgPSBib21NYXBJdGVtLmVuY29kaW5nO1xuXG5cdFx0XHRicmVhaztcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4geyBlbmNvZGluZzogZW5jb2RpbmcsIGJvbUxlbmd0aDogYm9tTGVuZ3RoIH07XG59XG5cbmludGVyZmFjZSBCb21NYXBJdGVtXG57XG5cdGJvbTogbnVtYmVyW107XG5cdGVuY29kaW5nOiBzdHJpbmc7XG59XG5cbmNvbnN0IHV0ZjhGaWxlVGV4dEVuY29kaW5nID0gXCJ1dGYtOFwiO1xuY29uc3QgZGVmYXVsdFRleHRGaWxlRW5jb2RpbmcgPSB1dGY4RmlsZVRleHRFbmNvZGluZztcblxubGV0IGJvbU1hcCA9XG5cdHtcblx0XHRib21VVEZfODogeyBib206IFsweEVGLCAweEJCLCAweEJGXSwgZW5jb2Rpbmc6IHV0ZjhGaWxlVGV4dEVuY29kaW5nIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbVVURl8xNl9CRTogeyBib206IFsweEZFLCAweEZGXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXHRcdGJvbVVURl8xNl9MRTogeyBib206IFsweEZGLCAweEZFXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tVVRGXzMyX0JFOiB7IGJvbTogWzB4MDAsIDB4MDAsIDB4RkUsIDB4RkZdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cdFx0Ym9tVVRGXzMyX0xFOiB7IGJvbTogWzB4RkYsIDB4RkUsIDB4MDAsIDB4MDBdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cblx0XHRib21VVEZfN19hOiB7IGJvbTogWzB4MkIsIDB4MkYsIDB4NzYsIDB4MzhdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cdFx0Ym9tVVRGXzdfYjogeyBib206IFsweDJCLCAweDJGLCAweDc2LCAweDM5XSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXHRcdGJvbVVURl83X2M6IHsgYm9tOiBbMHgyQiwgMHgyRiwgMHg3NiwgMHgyQl0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblx0XHRib21VVEZfN19kOiB7IGJvbTogWzB4MkIsIDB4MkYsIDB4NzYsIDB4MkZdLCBlbmNvZGluZzogXCJcIiB9IGFzIEJvbU1hcEl0ZW0sXG5cdFx0Ym9tVVRGXzdfZTogeyBib206IFsweDJCLCAweDJGLCAweDc2LCAweDM4LCAweDJEXSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tVVRGXzE6IHsgYm9tOiBbMHhGNywgMHg2NCwgMHg0Q10sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbVVURl9FQkNESUM6IHsgYm9tOiBbMHhERCwgMHg3MywgMHg2NiwgMHg3M10sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbVNDU1U6IHsgYm9tOiBbMHgwRSwgMHhGRSwgMHhGRl0sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblxuXHRcdGJvbUJPQ1VfMTogeyBib206IFsweEZCLCAweEVFLCAweDI4XSwgZW5jb2Rpbmc6IFwiXCIgfSBhcyBCb21NYXBJdGVtLFxuXG5cdFx0Ym9tR0JfMTgwMzA6IHsgYm9tOiBbMHg4NCwgMHgzMSwgMHg5NSwgMHgzM10sIGVuY29kaW5nOiBcIlwiIH0gYXMgQm9tTWFwSXRlbSxcblx0fTtcblxubGV0IG1heEJvbUxlbmd0aDogbnVtYmVyID0gMDtcblxuZm9yIChsZXQgYm9tTWFwSXRlbU5hbWUgaW4gYm9tTWFwKVxue1xuXHRsZXQgYm9tTWFwSXRlbSA9IChib21NYXAgYXMgYW55KVtib21NYXBJdGVtTmFtZV0gYXMgQm9tTWFwSXRlbTtcblx0bWF4Qm9tTGVuZ3RoID0gTWF0aC5tYXgobWF4Qm9tTGVuZ3RoLCBib21NYXBJdGVtLmJvbS5sZW5ndGgpO1xufVxuXG5mdW5jdGlvbiBpc0JvbU1hdGNoKG1hcEl0ZW06IEJvbU1hcEl0ZW0sIGJvbTogQnVmZmVyKVxue1xuXHRpZiAoYm9tLmxlbmd0aCA8IG1hcEl0ZW0uYm9tLmxlbmd0aClcblx0e1xuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgbWFwSXRlbS5ib20ubGVuZ3RoOyBpKyspXG5cdHtcblx0XHRpZiAoYm9tW2ldICE9IG1hcEl0ZW0uYm9tW2ldKVxuXHRcdHtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gdHJ1ZTtcbn1cblxuLy8gVE9ETzogc2hhcmUgdGhlc2UsIG9yIHRyeSBmcy1wcm9taXNlIChvciBzaW1pbGFyKVxuZnVuY3Rpb24gZmlsZVN0YXQocGF0aDogc3RyaW5nIHwgQnVmZmVyKTogUHJvbWlzZTxmcy5TdGF0cz5cbntcblx0cmV0dXJuIG5ldyBQcm9taXNlPGZzLlN0YXRzPihcblx0XHRmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KVxuXHRcdHtcblx0XHRcdGZzLnN0YXQoXG5cdFx0XHRcdHBhdGgsXG5cdFx0XHRcdGZ1bmN0aW9uIChlcnIsIHN0YXRzKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKChudWxsICE9PSBlcnIpICYmICh1bmRlZmluZWQgIT09IGVycikpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVqZWN0KGVycik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZXNvbHZlKHN0YXRzKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdH0pO1xufVxuXG5mdW5jdGlvbiBvcGVuRmlsZShwYXRoOiBzdHJpbmcgfCBCdWZmZXIsIGZsYWdzOiBzdHJpbmcgfCBudW1iZXIpOiBQcm9taXNlPG51bWJlcj5cbntcblx0cmV0dXJuIG5ldyBQcm9taXNlPG51bWJlcj4oXG5cdFx0ZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdClcblx0XHR7XG5cdFx0XHRmcy5vcGVuKFxuXHRcdFx0XHRwYXRoLFxuXHRcdFx0XHRmbGFncyxcblx0XHRcdFx0ZnVuY3Rpb24gKGVyciwgZmQpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRpZiAoKG51bGwgIT09IGVycikgJiYgKHVuZGVmaW5lZCAhPT0gZXJyKSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlc29sdmUoZmQpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0fSk7XG59XG5cbmludGVyZmFjZSBSZWFkRmlsZVJlc3VsdFxue1xuXHRieXRlc1JlYWQ6IG51bWJlcjtcblx0YnVmZmVyOiBCdWZmZXI7XG59XG5cbmZ1bmN0aW9uIHJlYWRGaWxlKGZkOiBudW1iZXIsIGJ1ZmZlcjogQnVmZmVyLCBvZmZzZXQ6IG51bWJlciwgbGVuZ3RoOiBudW1iZXIsIHBvc2l0aW9uOiBudW1iZXIpOiBQcm9taXNlPFJlYWRGaWxlUmVzdWx0Plxue1xuXHRyZXR1cm4gbmV3IFByb21pc2U8UmVhZEZpbGVSZXN1bHQ+KFxuXHRcdGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpXG5cdFx0e1xuXHRcdFx0ZnMucmVhZChcblx0XHRcdFx0ZmQsXG5cdFx0XHRcdGJ1ZmZlcixcblx0XHRcdFx0b2Zmc2V0LFxuXHRcdFx0XHRsZW5ndGgsXG5cdFx0XHRcdHBvc2l0aW9uLFxuXHRcdFx0XHRmdW5jdGlvbiAoZXJyLCBieXRlc1JlYWQsIGJ1ZmZlcilcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGlmICgobnVsbCAhPT0gZXJyKSAmJiAodW5kZWZpbmVkICE9PSBlcnIpKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlamVjdChlcnIpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVzb2x2ZSh7IGJ5dGVzUmVhZDogYnl0ZXNSZWFkLCBidWZmZXI6IGJ1ZmZlciB9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdH0pO1xufVxuXG5mdW5jdGlvbiBjbG9zZUZpbGUoZmQ6IG51bWJlcik6IFByb21pc2U8dm9pZD5cbntcblx0cmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KFxuXHRcdGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpXG5cdFx0e1xuXHRcdFx0ZnMuY2xvc2UoXG5cdFx0XHRcdGZkLFxuXHRcdFx0XHRmdW5jdGlvbiAoZXJyKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKChudWxsICE9PSBlcnIpICYmICh1bmRlZmluZWQgIT09IGVycikpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0cmVqZWN0KGVycik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZXNvbHZlKCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHR9KTtcbn0iXX0=